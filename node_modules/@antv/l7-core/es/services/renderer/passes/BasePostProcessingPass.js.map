{"version":3,"sources":["../../../../src/services/renderer/passes/BasePostProcessingPass.ts"],"names":["inject","injectable","gl","TYPES","PassType","BasePostProcessingPass","IShaderModuleService","quad","name","PostProcessing","layer","config","rendererService","getContainer","get","IRendererService","createAttribute","createBuffer","createModel","setupShaders","vs","fs","uniforms","model","attributes","a_Position","buffer","data","type","FLOAT","size","u_Texture","convertOptionsToUniforms","depth","enable","count","blend","getName","postProcessor","multiPassRenderer","getPostProcessor","useFramebuffer","getViewportSize","clear","width","height","renderToScreen","getWriteFBO","framebuffer","color","stencil","draw","getReadFBO","u_ViewportSize","optionsToUpdate","enabled","Error","options","Object","keys","forEach","optionName"],"mappings":"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","sourcesContent":["import { inject, injectable } from 'inversify';\nimport { camelCase, isNil, upperFirst } from 'lodash';\nimport 'reflect-metadata';\nimport { IShaderModuleService } from '../../shader/IShaderModuleService';\nimport { gl } from '../gl';\nimport { IModel } from '../IModel';\nimport { IRendererService } from '../IRendererService';\n\nimport quad from '../../../shaders/post-processing/quad.glsl';\nimport { TYPES } from '../../../types';\nimport { ILayer } from '../../layer/ILayerService';\nimport { IPostProcessingPass, PassType } from '../IMultiPassRenderer';\nimport { IUniform } from '../IUniform';\n\n/**\n * 后处理 Pass 基类，通过 PostProcessor 驱动。\n *\n * 约定使用 u_Texture 传递渲染纹理。\n */\n@injectable()\nexport default class BasePostProcessingPass<InitializationOptions = {}>\n  implements IPostProcessingPass<InitializationOptions> {\n  @inject(TYPES.IShaderModuleService)\n  protected readonly shaderModuleService: IShaderModuleService;\n\n  protected rendererService: IRendererService;\n\n  protected config: Partial<InitializationOptions> | undefined;\n\n  protected quad: string = quad;\n\n  /**\n   * 启用开关\n   */\n  private enabled: boolean = true;\n\n  /**\n   * 是否渲染到屏幕\n   */\n  private renderToScreen: boolean = false;\n\n  /**\n   * 渲染命令\n   */\n  private model: IModel;\n\n  /**\n   * 效果名，便于在图层中引用\n   */\n  private name: string;\n\n  private optionsToUpdate: Partial<InitializationOptions> = {};\n\n  public getName() {\n    return this.name;\n  }\n\n  public setName(name: string) {\n    this.name = name;\n  }\n\n  public getType() {\n    return PassType.PostProcessing;\n  }\n\n  public init(layer: ILayer, config?: Partial<InitializationOptions>) {\n    this.config = config;\n    this.rendererService = layer\n      .getContainer()\n      .get<IRendererService>(TYPES.IRendererService);\n\n    const { createAttribute, createBuffer, createModel } = this.rendererService;\n    const { vs, fs, uniforms } = this.setupShaders();\n\n    this.model = createModel({\n      vs,\n      fs,\n      attributes: {\n        // 使用一个全屏三角形，相比 Quad 顶点数目更少\n        a_Position: createAttribute({\n          buffer: createBuffer({\n            data: [-4, -4, 4, -4, 0, 4],\n            type: gl.FLOAT,\n          }),\n          size: 2,\n        }),\n      },\n      // @ts-ignore\n      uniforms: {\n        // @ts-ignore\n        u_Texture: null,\n        ...uniforms,\n        ...(this.config && this.convertOptionsToUniforms(this.config)),\n      },\n      depth: {\n        enable: false,\n      },\n      count: 3,\n      blend: {\n        // copy pass 需要混合\n        enable: this.getName() === 'copy',\n      },\n    });\n  }\n\n  public render(layer: ILayer) {\n    const postProcessor = layer.multiPassRenderer.getPostProcessor();\n    const { useFramebuffer, getViewportSize, clear } = this.rendererService;\n    const { width, height } = getViewportSize();\n    useFramebuffer(\n      this.renderToScreen ? null : postProcessor.getWriteFBO(),\n      () => {\n        clear({\n          framebuffer: postProcessor.getWriteFBO(),\n          color: [0, 0, 0, 0],\n          depth: 1,\n          stencil: 0,\n        });\n        this.model.draw({\n          uniforms: {\n            u_Texture: postProcessor.getReadFBO(),\n            u_ViewportSize: [width, height],\n            ...this.convertOptionsToUniforms(this.optionsToUpdate),\n          },\n        });\n      },\n    );\n  }\n\n  public isEnabled() {\n    return this.enabled;\n  }\n\n  public setEnabled(enabled: boolean) {\n    this.enabled = enabled;\n  }\n\n  public setRenderToScreen(renderToScreen: boolean) {\n    this.renderToScreen = renderToScreen;\n  }\n\n  public updateOptions(config: Partial<InitializationOptions>) {\n    this.optionsToUpdate = {\n      ...this.optionsToUpdate,\n      ...config,\n    };\n  }\n\n  protected setupShaders(): {\n    vs: string;\n    fs: string;\n    uniforms?: { [key: string]: IUniform };\n  } {\n    throw new Error('Method not implemented.');\n  }\n\n  protected convertOptionsToUniforms(\n    options: Partial<InitializationOptions>,\n  ): {\n    [uniformName: string]: IUniform;\n  } | void {\n    const uniforms: {\n      [key: string]: IUniform;\n    } = {};\n\n    Object.keys(options).forEach((optionName) => {\n      // @ts-ignore\n      if (!isNil(options[optionName])) {\n        uniforms[`u_${upperFirst(camelCase(optionName))}`] =\n          // @ts-ignore\n          options[optionName];\n      }\n    });\n\n    return uniforms;\n  }\n}\n"],"file":"BasePostProcessingPass.js"}