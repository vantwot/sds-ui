{"ast":null,"code":"var __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n      d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\n\nvar __metadata = this && this.__metadata || function (k, v) {\n  if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(k, v);\n};\n\nvar __param = this && this.__param || function (paramIndex, decorator) {\n  return function (target, key) {\n    decorator(target, key, paramIndex);\n  };\n};\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nimport { contrib, Contribution, singleton } from 'mana-syringe';\nimport { RxModel } from '../common/rx-model';\nimport { Disposable, DisposableCollection } from '../common/disposable';\nimport { IFrontendApplicationContribution } from '../xflow-main/interface';\nimport { IGraphCommandService, IGraphCommandContribution } from './interface';\nimport 'reflect-metadata';\nexport var NCommand;\n\n(function (NCommand) {\n  /* Determine whether object is a Command */\n  function is(arg) {\n    return !!arg && arg === Object(arg) && 'id' in arg;\n  }\n\n  NCommand.is = is;\n  /** Comparator function for when sorting commands */\n\n  function compareCommands(a, b) {\n    if (a.label && b.label) {\n      const aCommand = (a.category ? `${a.category}: ${a.label}` : a.label).toLowerCase();\n      const bCommand = (b.category ? `${b.category}: ${b.label}` : b.label).toLowerCase();\n      return aCommand.localeCompare(bCommand);\n    } else {\n      return 0;\n    }\n  }\n\n  NCommand.compareCommands = compareCommands;\n  /**\n   * Determine if two commands are equal.\n   *\n   * @param a the first command for comparison.\n   * @param b the second command for comparison.\n   */\n\n  function equals(a, b) {\n    return a.id === b.id && a.label === b.label && a.iconName === b.iconName && a.category === b.category;\n  }\n\n  NCommand.equals = equals;\n})(NCommand || (NCommand = {}));\n\nlet GraphCommandRegistry = class GraphCommandRegistry {\n  constructor(contributionProvider) {\n    this.contributionProvider = contributionProvider;\n    /**\n     * undo cmd后将命令存储在队列中给redo调用\n     */\n\n    this.redoStack = [];\n    /**\n     * executeCommand后将命令存储在队列中给undo调用\n     */\n\n    this.undoStack = [];\n    /**\n     * 储存所有注册的command\n     */\n\n    this.commands = new Map();\n    /**\n     * 储存所有注册的command factory\n     */\n\n    this.factories = new Map();\n    /**\n     * 储存所有注册的command handler disposables\n     */\n\n    this.disposables = new Map();\n    /**\n     * 监听cmdregistry的变化\n     */\n\n    this.cmdChangeEvent = new RxModel(null);\n    /**\n     * 在Command实例间共享变量\n     */\n\n    this.Globals = new RxModel(new Map());\n    /** 设置command间的共享变量 */\n\n    this.setGlobal = (key, value) => {\n      this.Globals.setValue(map => {\n        map.set(key, value);\n      });\n    };\n    /** 获取共享变量 */\n\n\n    this.getGlobal = key => {\n      const map = this.Globals.getValue();\n      return map.get(key);\n    };\n    /**\n     * 执行undo stack中最后一条Command\n     */\n\n\n    this.undoCommand = () => __awaiter(this, void 0, void 0, function* () {\n      /* 获取可以undo的Command */\n      const cmd = this.undoStack.pop();\n\n      if (!cmd) {\n        console.error('empty undo stack');\n        return;\n      }\n      /* 执行命令的undo方法 */\n\n\n      yield cmd.undo();\n      /* 执行后塞到redo的栈中 */\n\n      this.redoStack.push(cmd);\n      /* 触发事件回调 */\n\n      this.cmdChangeEvent.setValue(null);\n    });\n    /**\n     * 执行redo stack中最后一条Command\n     */\n\n\n    this.redoCommand = () => __awaiter(this, void 0, void 0, function* () {\n      /* 获取可以redo的Command */\n      const cmd = this.redoStack.pop();\n\n      if (!cmd) {\n        console.error('empty undo stack');\n        return;\n      }\n      /* 执行命令的undo */\n\n\n      yield cmd.redo();\n      /* 执行后塞到undo的栈中 */\n\n      this.undoStack.push(cmd);\n      /* 触发事件回调 */\n\n      this.cmdChangeEvent.setValue(null);\n    });\n    /**\n     * 注册一批可单独dispose的Command\n     * @param externalRegisterFn ICommandRegisterFunction\n     */\n\n\n    this.registerDisposableCommand = externalRegisterFn => {\n      const toDispose = new DisposableCollection();\n      const disposableRegistry = {\n        registerCommand: (command, factory) => {\n          const disposable = this.registerCommand(command, factory);\n          toDispose.push(disposable);\n          return disposable;\n        }\n      };\n      externalRegisterFn(disposableRegistry);\n      return toDispose;\n    };\n  }\n  /**\n   * 监听cmdregistry的变化\n   */\n\n\n  get watchChange() {\n    return this.cmdChangeEvent.watch;\n  }\n\n  onStart() {\n    const contributions = this.contributionProvider.getContributions();\n\n    for (const contribItem of contributions) {\n      contribItem.registerGraphCommands(this);\n    }\n  }\n\n  executeCommandPipeline(cmdOptions) {\n    return __awaiter(this, void 0, void 0, function* () {\n      let res = null;\n\n      for (const cmdOption of cmdOptions) {\n        const cmdCtx = res === null || res === void 0 ? void 0 : res.contextProvider();\n        const {\n          args,\n          hooks\n        } = yield cmdOption === null || cmdOption === void 0 ? void 0 : cmdOption.getCommandOption(cmdCtx);\n        res = yield this.executeCommand(cmdOption === null || cmdOption === void 0 ? void 0 : cmdOption.commandId, args, hooks);\n      }\n      /* 触发事件回调 */\n\n\n      this.cmdChangeEvent.setValue(null);\n      return res;\n    });\n  }\n  /** 执行 Command：会在undo stack中push cmd */\n\n\n  executeCommand(commandId, cmdArgs) {\n    let hook = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];\n    return __awaiter(this, void 0, void 0, function* () {\n      const factory = this.getFactory(commandId);\n\n      if (factory) {\n        const cmd = yield factory.createCommand(commandId, cmdArgs, hook);\n        yield cmd.execute();\n\n        if (cmd.isUndoable()) {\n          this.undoStack.push(cmd);\n        }\n        /* 触发事件回调 */\n\n\n        this.cmdChangeEvent.setValue(null);\n        return cmd;\n      }\n\n      throw Object.assign(new Error(`The command '${commandId}' cannot be executed. There are no active handlers available for the command.`), {\n        code: 'NO_ACTIVE_HANDLER'\n      });\n    });\n  }\n  /** 执行 unod Command：不会在undo stack中push新的command记录 */\n\n\n  executeUndoCommand(commandId, cmdArgs) {\n    let hook = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];\n    return __awaiter(this, void 0, void 0, function* () {\n      const factory = this.getFactory(commandId);\n\n      if (factory) {\n        const cmd = yield factory.createCommand(commandId, cmdArgs, hook);\n        yield cmd.execute();\n        return cmd;\n      }\n\n      throw Object.assign(new Error(`The command '${commandId}' cannot be executed. There are no active handlers available for the command.`), {\n        code: 'NO_ACTIVE_HANDLER'\n      });\n    });\n  }\n  /**\n   * Execute the active handler for the given command and arguments.\n   *\n   * Reject if a command cannot be executed.\n   */\n\n\n  createCommand(commandId, cmdArgs) {\n    let hook = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];\n    return __awaiter(this, void 0, void 0, function* () {\n      const factory = this.getFactory(commandId);\n\n      if (factory) {\n        const cmd = yield factory.createCommand(commandId, cmdArgs, hook);\n        return cmd;\n      }\n\n      throw Object.assign(new Error(`The command '${commandId}' cannot be executed. There are no active handlers available for the command.`), {\n        code: 'NO_ACTIVE_HANDLER'\n      });\n    });\n  }\n  /**\n   * 检查是否注册了Command\n   */\n\n\n  get isUndoable() {\n    return this.undoStack.length > 0;\n  }\n  /**\n   * 检查是否注册了Command\n   */\n\n\n  get isRedoable() {\n    return this.redoStack.length > 0;\n  }\n  /**\n   * 检查是否注册了Command\n   */\n\n\n  hasCommand(commandId) {\n    return this.commands.has(commandId);\n  }\n  /**\n   * Get a command for the given command identifier.\n   */\n\n\n  getCommand(id) {\n    return this.commands.get(id);\n  }\n  /**\n   * Register the given command and handler if present.\n   *\n   * Throw if a command is already registered for the given command identifier.\n   */\n\n\n  registerCommand(command, factory) {\n    if (this.factories.has(command.id)) {\n      console.warn(`A command ${command.id} is already registered.`);\n      return Disposable.NULL;\n    }\n\n    const toDispose = new DisposableCollection(this.doRegisterCommand(command), this.registerFactory(command.id, factory), Disposable.create(() => this.disposables.delete(command.id)));\n    this.disposables.set(command.id, toDispose);\n    return toDispose;\n  }\n\n  doRegisterCommand(command) {\n    this.commands.set(command.id, command);\n    return Disposable.create(() => this.disposables.delete(command.id));\n  }\n  /**\n   * Unregister command from the registry\n   *\n   * @param id\n   */\n\n\n  unregisterCommand(commandOrId) {\n    const id = NCommand.is(commandOrId) ? commandOrId.id : commandOrId;\n    const disposableCmd = this.disposables.get(id);\n\n    if (disposableCmd) {\n      disposableCmd.dispose();\n    }\n  }\n  /**\n   * 检查commandId是否有Factory\n   */\n\n\n  hasFactory(commandId) {\n    const factory = this.factories.get(commandId);\n    return !!factory;\n  }\n  /**\n   * Get a visible handler for the given command or `undefined`.\n   */\n\n\n  getFactory(commandId) {\n    const factory = this.factories.get(commandId);\n    return factory;\n  }\n  /**\n   * Register the given handler for the given command identifier.\n   *\n   * If there is already a handler for the given command\n   * then the given handler is registered as more specific, and\n   * has higher priority during enablement, visibility and toggle state evaluations.\n   */\n\n\n  registerFactory(commandId, factory) {\n    let force = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;\n\n    if (this.hasFactory(commandId) && force === false) {\n      console.error('cannot register command:', commandId);\n    }\n\n    this.factories.set(commandId, factory);\n    return Disposable.create(() => {\n      this.factories.delete(commandId);\n    });\n  }\n  /**\n   * Returns with all handlers for the given command. If the command does not have any handlers,\n   * or the command is not registered, returns an empty array.\n   */\n\n\n  getAllFactories() {\n    return Array.from(this.factories.entries());\n  }\n\n};\nGraphCommandRegistry = __decorate([singleton({\n  contrib: [IFrontendApplicationContribution, IGraphCommandService]\n}), __param(0, contrib(IGraphCommandContribution)), __metadata(\"design:paramtypes\", [Object])], GraphCommandRegistry);\nexport { GraphCommandRegistry };","map":{"version":3,"sources":["../../src/command/graph-command.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\nvar __metadata = (this && this.__metadata) || function (k, v) {\n    if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(k, v);\n};\nvar __param = (this && this.__param) || function (paramIndex, decorator) {\n    return function (target, key) { decorator(target, key, paramIndex); }\n};\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nimport { contrib, Contribution, singleton } from 'mana-syringe';\nimport { RxModel } from '../common/rx-model';\nimport { Disposable, DisposableCollection } from '../common/disposable';\nimport { IFrontendApplicationContribution } from '../xflow-main/interface';\nimport { IGraphCommandService, IGraphCommandContribution } from './interface';\nimport 'reflect-metadata';\nexport var NCommand;\n(function (NCommand) {\n    /* Determine whether object is a Command */\n    function is(arg) {\n        return !!arg && arg === Object(arg) && 'id' in arg;\n    }\n    NCommand.is = is;\n    /** Comparator function for when sorting commands */\n    function compareCommands(a, b) {\n        if (a.label && b.label) {\n            const aCommand = (a.category ? `${a.category}: ${a.label}` : a.label).toLowerCase();\n            const bCommand = (b.category ? `${b.category}: ${b.label}` : b.label).toLowerCase();\n            return aCommand.localeCompare(bCommand);\n        }\n        else {\n            return 0;\n        }\n    }\n    NCommand.compareCommands = compareCommands;\n    /**\n     * Determine if two commands are equal.\n     *\n     * @param a the first command for comparison.\n     * @param b the second command for comparison.\n     */\n    function equals(a, b) {\n        return (a.id === b.id && a.label === b.label && a.iconName === b.iconName && a.category === b.category);\n    }\n    NCommand.equals = equals;\n})(NCommand || (NCommand = {}));\nlet GraphCommandRegistry = class GraphCommandRegistry {\n    constructor(contributionProvider) {\n        this.contributionProvider = contributionProvider;\n        /**\n         * undo cmd后将命令存储在队列中给redo调用\n         */\n        this.redoStack = [];\n        /**\n         * executeCommand后将命令存储在队列中给undo调用\n         */\n        this.undoStack = [];\n        /**\n         * 储存所有注册的command\n         */\n        this.commands = new Map();\n        /**\n         * 储存所有注册的command factory\n         */\n        this.factories = new Map();\n        /**\n         * 储存所有注册的command handler disposables\n         */\n        this.disposables = new Map();\n        /**\n         * 监听cmdregistry的变化\n         */\n        this.cmdChangeEvent = new RxModel(null);\n        /**\n         * 在Command实例间共享变量\n         */\n        this.Globals = new RxModel(new Map());\n        /** 设置command间的共享变量 */\n        this.setGlobal = (key, value) => {\n            this.Globals.setValue(map => {\n                map.set(key, value);\n            });\n        };\n        /** 获取共享变量 */\n        this.getGlobal = (key) => {\n            const map = this.Globals.getValue();\n            return map.get(key);\n        };\n        /**\n         * 执行undo stack中最后一条Command\n         */\n        this.undoCommand = () => __awaiter(this, void 0, void 0, function* () {\n            /* 获取可以undo的Command */\n            const cmd = this.undoStack.pop();\n            if (!cmd) {\n                console.error('empty undo stack');\n                return;\n            }\n            /* 执行命令的undo方法 */\n            yield cmd.undo();\n            /* 执行后塞到redo的栈中 */\n            this.redoStack.push(cmd);\n            /* 触发事件回调 */\n            this.cmdChangeEvent.setValue(null);\n        });\n        /**\n         * 执行redo stack中最后一条Command\n         */\n        this.redoCommand = () => __awaiter(this, void 0, void 0, function* () {\n            /* 获取可以redo的Command */\n            const cmd = this.redoStack.pop();\n            if (!cmd) {\n                console.error('empty undo stack');\n                return;\n            }\n            /* 执行命令的undo */\n            yield cmd.redo();\n            /* 执行后塞到undo的栈中 */\n            this.undoStack.push(cmd);\n            /* 触发事件回调 */\n            this.cmdChangeEvent.setValue(null);\n        });\n        /**\n         * 注册一批可单独dispose的Command\n         * @param externalRegisterFn ICommandRegisterFunction\n         */\n        this.registerDisposableCommand = (externalRegisterFn) => {\n            const toDispose = new DisposableCollection();\n            const disposableRegistry = {\n                registerCommand: (command, factory) => {\n                    const disposable = this.registerCommand(command, factory);\n                    toDispose.push(disposable);\n                    return disposable;\n                },\n            };\n            externalRegisterFn(disposableRegistry);\n            return toDispose;\n        };\n    }\n    /**\n     * 监听cmdregistry的变化\n     */\n    get watchChange() {\n        return this.cmdChangeEvent.watch;\n    }\n    onStart() {\n        const contributions = this.contributionProvider.getContributions();\n        for (const contribItem of contributions) {\n            contribItem.registerGraphCommands(this);\n        }\n    }\n    executeCommandPipeline(cmdOptions) {\n        return __awaiter(this, void 0, void 0, function* () {\n            let res = null;\n            for (const cmdOption of cmdOptions) {\n                const cmdCtx = res === null || res === void 0 ? void 0 : res.contextProvider();\n                const { args, hooks } = yield (cmdOption === null || cmdOption === void 0 ? void 0 : cmdOption.getCommandOption(cmdCtx));\n                res = yield this.executeCommand(cmdOption === null || cmdOption === void 0 ? void 0 : cmdOption.commandId, args, hooks);\n            }\n            /* 触发事件回调 */\n            this.cmdChangeEvent.setValue(null);\n            return res;\n        });\n    }\n    /** 执行 Command：会在undo stack中push cmd */\n    executeCommand(commandId, cmdArgs, hook = []) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const factory = this.getFactory(commandId);\n            if (factory) {\n                const cmd = (yield factory.createCommand(commandId, cmdArgs, hook));\n                yield cmd.execute();\n                if (cmd.isUndoable()) {\n                    this.undoStack.push(cmd);\n                }\n                /* 触发事件回调 */\n                this.cmdChangeEvent.setValue(null);\n                return cmd;\n            }\n            throw Object.assign(new Error(`The command '${commandId}' cannot be executed. There are no active handlers available for the command.`), { code: 'NO_ACTIVE_HANDLER' });\n        });\n    }\n    /** 执行 unod Command：不会在undo stack中push新的command记录 */\n    executeUndoCommand(commandId, cmdArgs, hook = []) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const factory = this.getFactory(commandId);\n            if (factory) {\n                const cmd = yield factory.createCommand(commandId, cmdArgs, hook);\n                yield cmd.execute();\n                return cmd;\n            }\n            throw Object.assign(new Error(`The command '${commandId}' cannot be executed. There are no active handlers available for the command.`), { code: 'NO_ACTIVE_HANDLER' });\n        });\n    }\n    /**\n     * Execute the active handler for the given command and arguments.\n     *\n     * Reject if a command cannot be executed.\n     */\n    createCommand(commandId, cmdArgs, hook = []) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const factory = this.getFactory(commandId);\n            if (factory) {\n                const cmd = yield factory.createCommand(commandId, cmdArgs, hook);\n                return cmd;\n            }\n            throw Object.assign(new Error(`The command '${commandId}' cannot be executed. There are no active handlers available for the command.`), { code: 'NO_ACTIVE_HANDLER' });\n        });\n    }\n    /**\n     * 检查是否注册了Command\n     */\n    get isUndoable() {\n        return this.undoStack.length > 0;\n    }\n    /**\n     * 检查是否注册了Command\n     */\n    get isRedoable() {\n        return this.redoStack.length > 0;\n    }\n    /**\n     * 检查是否注册了Command\n     */\n    hasCommand(commandId) {\n        return this.commands.has(commandId);\n    }\n    /**\n     * Get a command for the given command identifier.\n     */\n    getCommand(id) {\n        return this.commands.get(id);\n    }\n    /**\n     * Register the given command and handler if present.\n     *\n     * Throw if a command is already registered for the given command identifier.\n     */\n    registerCommand(command, factory) {\n        if (this.factories.has(command.id)) {\n            console.warn(`A command ${command.id} is already registered.`);\n            return Disposable.NULL;\n        }\n        const toDispose = new DisposableCollection(this.doRegisterCommand(command), this.registerFactory(command.id, factory), Disposable.create(() => this.disposables.delete(command.id)));\n        this.disposables.set(command.id, toDispose);\n        return toDispose;\n    }\n    doRegisterCommand(command) {\n        this.commands.set(command.id, command);\n        return Disposable.create(() => this.disposables.delete(command.id));\n    }\n    /**\n     * Unregister command from the registry\n     *\n     * @param id\n     */\n    unregisterCommand(commandOrId) {\n        const id = NCommand.is(commandOrId) ? commandOrId.id : commandOrId;\n        const disposableCmd = this.disposables.get(id);\n        if (disposableCmd) {\n            disposableCmd.dispose();\n        }\n    }\n    /**\n     * 检查commandId是否有Factory\n     */\n    hasFactory(commandId) {\n        const factory = this.factories.get(commandId);\n        return !!factory;\n    }\n    /**\n     * Get a visible handler for the given command or `undefined`.\n     */\n    getFactory(commandId) {\n        const factory = this.factories.get(commandId);\n        return factory;\n    }\n    /**\n     * Register the given handler for the given command identifier.\n     *\n     * If there is already a handler for the given command\n     * then the given handler is registered as more specific, and\n     * has higher priority during enablement, visibility and toggle state evaluations.\n     */\n    registerFactory(commandId, factory, force = false) {\n        if (this.hasFactory(commandId) && force === false) {\n            console.error('cannot register command:', commandId);\n        }\n        this.factories.set(commandId, factory);\n        return Disposable.create(() => {\n            this.factories.delete(commandId);\n        });\n    }\n    /**\n     * Returns with all handlers for the given command. If the command does not have any handlers,\n     * or the command is not registered, returns an empty array.\n     */\n    getAllFactories() {\n        return Array.from(this.factories.entries());\n    }\n};\nGraphCommandRegistry = __decorate([\n    singleton({\n        contrib: [IFrontendApplicationContribution, IGraphCommandService],\n    }),\n    __param(0, contrib(IGraphCommandContribution)),\n    __metadata(\"design:paramtypes\", [Object])\n], GraphCommandRegistry);\nexport { GraphCommandRegistry };\n//# sourceMappingURL=graph-command.js.map"]},"metadata":{},"sourceType":"module"}