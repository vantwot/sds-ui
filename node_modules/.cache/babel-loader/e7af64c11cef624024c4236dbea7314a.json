{"ast":null,"code":"import _typeof from \"@babel/runtime/helpers/typeof\";\nimport _classCallCheck from \"@babel/runtime/helpers/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/createClass\";\nimport _defineProperty from \"@babel/runtime/helpers/defineProperty\";\nimport _isTypedArray from \"lodash/isTypedArray\";\nimport _isPlainObject from \"lodash/isPlainObject\";\n\nfunction ownKeys(object, enumerableOnly) {\n  var keys = Object.keys(object);\n\n  if (Object.getOwnPropertySymbols) {\n    var symbols = Object.getOwnPropertySymbols(object);\n\n    if (enumerableOnly) {\n      symbols = symbols.filter(function (sym) {\n        return Object.getOwnPropertyDescriptor(object, sym).enumerable;\n      });\n    }\n\n    keys.push.apply(keys, symbols);\n  }\n\n  return keys;\n}\n\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i] != null ? arguments[i] : {};\n\n    if (i % 2) {\n      ownKeys(Object(source), true).forEach(function (key) {\n        _defineProperty(target, key, source[key]);\n      });\n    } else if (Object.getOwnPropertyDescriptors) {\n      Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));\n    } else {\n      ownKeys(Object(source)).forEach(function (key) {\n        Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));\n      });\n    }\n  }\n\n  return target;\n}\n\nimport { gl } from '@antv/l7-core';\nimport { blendEquationMap, blendFuncMap, cullFaceMap, depthFuncMap, primitiveMap, stencilFuncMap, stencilOpMap } from './constants';\n\nvar ReglModel = function () {\n  function ReglModel(reGl, options) {\n    _classCallCheck(this, ReglModel);\n\n    _defineProperty(this, \"reGl\", void 0);\n\n    _defineProperty(this, \"destroyed\", false);\n\n    _defineProperty(this, \"drawCommand\", void 0);\n\n    _defineProperty(this, \"drawParams\", void 0);\n\n    _defineProperty(this, \"options\", void 0);\n\n    _defineProperty(this, \"uniforms\", {});\n\n    this.reGl = reGl;\n    var vs = options.vs,\n        fs = options.fs,\n        attributes = options.attributes,\n        uniforms = options.uniforms,\n        primitive = options.primitive,\n        count = options.count,\n        elements = options.elements,\n        depth = options.depth,\n        blend = options.blend,\n        stencil = options.stencil,\n        cull = options.cull,\n        instances = options.instances;\n    var reglUniforms = {};\n    this.options = options;\n\n    if (uniforms) {\n      this.uniforms = this.extractUniforms(uniforms);\n      Object.keys(uniforms).forEach(function (uniformName) {\n        reglUniforms[uniformName] = reGl.prop(uniformName);\n      });\n    }\n\n    var reglAttributes = {};\n    Object.keys(attributes).forEach(function (name) {\n      reglAttributes[name] = attributes[name].get();\n    });\n    var drawParams = {\n      attributes: reglAttributes,\n      frag: fs,\n      uniforms: reglUniforms,\n      vert: vs,\n      primitive: primitiveMap[primitive === undefined ? gl.TRIANGLES : primitive]\n    };\n\n    if (instances) {\n      drawParams.instances = instances;\n    }\n\n    if (count) {\n      drawParams.count = count;\n    }\n\n    if (elements) {\n      drawParams.elements = elements.get();\n    }\n\n    this.initDepthDrawParams({\n      depth: depth\n    }, drawParams);\n    this.initBlendDrawParams({\n      blend: blend\n    }, drawParams);\n    this.initStencilDrawParams({\n      stencil: stencil\n    }, drawParams);\n    this.initCullDrawParams({\n      cull: cull\n    }, drawParams);\n    this.drawCommand = reGl(drawParams);\n    this.drawParams = drawParams;\n  }\n\n  _createClass(ReglModel, [{\n    key: \"addUniforms\",\n    value: function addUniforms(uniforms) {\n      this.uniforms = _objectSpread(_objectSpread({}, this.uniforms), this.extractUniforms(uniforms));\n    }\n  }, {\n    key: \"draw\",\n    value: function draw(options) {\n      if (this.drawParams.attributes && Object.keys(this.drawParams.attributes).length === 0) {\n        return;\n      }\n\n      var uniforms = _objectSpread(_objectSpread({}, this.uniforms), this.extractUniforms(options.uniforms || {}));\n\n      var reglDrawProps = {};\n      Object.keys(uniforms).forEach(function (uniformName) {\n        var type = _typeof(uniforms[uniformName]);\n\n        if (type === 'boolean' || type === 'number' || Array.isArray(uniforms[uniformName]) || uniforms[uniformName].BYTES_PER_ELEMENT) {\n          reglDrawProps[uniformName] = uniforms[uniformName];\n        } else {\n          reglDrawProps[uniformName] = uniforms[uniformName].get();\n        }\n      });\n      this.drawCommand(reglDrawProps);\n    }\n  }, {\n    key: \"destroy\",\n    value: function destroy() {\n      this.drawParams.elements.destroy();\n\n      if (this.options.attributes) {\n        Object.values(this.options.attributes).forEach(function (attr) {\n          attr.destroy();\n        });\n      }\n\n      this.destroyed = true;\n    }\n  }, {\n    key: \"initDepthDrawParams\",\n    value: function initDepthDrawParams(_ref, drawParams) {\n      var depth = _ref.depth;\n\n      if (depth) {\n        drawParams.depth = {\n          enable: depth.enable === undefined ? true : !!depth.enable,\n          mask: depth.mask === undefined ? true : !!depth.mask,\n          func: depthFuncMap[depth.func || gl.LESS],\n          range: depth.range || [0, 1]\n        };\n      }\n    }\n  }, {\n    key: \"initBlendDrawParams\",\n    value: function initBlendDrawParams(_ref2, drawParams) {\n      var blend = _ref2.blend;\n\n      if (blend) {\n        var enable = blend.enable,\n            func = blend.func,\n            equation = blend.equation,\n            _blend$color = blend.color,\n            color = _blend$color === void 0 ? [0, 0, 0, 0] : _blend$color;\n        drawParams.blend = {\n          enable: !!enable,\n          func: {\n            srcRGB: blendFuncMap[func && func.srcRGB || gl.SRC_ALPHA],\n            srcAlpha: blendFuncMap[func && func.srcAlpha || gl.SRC_ALPHA],\n            dstRGB: blendFuncMap[func && func.dstRGB || gl.ONE_MINUS_SRC_ALPHA],\n            dstAlpha: blendFuncMap[func && func.dstAlpha || gl.ONE_MINUS_SRC_ALPHA]\n          },\n          equation: {\n            rgb: blendEquationMap[equation && equation.rgb || gl.FUNC_ADD],\n            alpha: blendEquationMap[equation && equation.alpha || gl.FUNC_ADD]\n          },\n          color: color\n        };\n      }\n    }\n  }, {\n    key: \"initStencilDrawParams\",\n    value: function initStencilDrawParams(_ref3, drawParams) {\n      var stencil = _ref3.stencil;\n\n      if (stencil) {\n        var enable = stencil.enable,\n            _stencil$mask = stencil.mask,\n            mask = _stencil$mask === void 0 ? -1 : _stencil$mask,\n            _stencil$func = stencil.func,\n            func = _stencil$func === void 0 ? {\n          cmp: gl.ALWAYS,\n          ref: 0,\n          mask: -1\n        } : _stencil$func,\n            _stencil$opFront = stencil.opFront,\n            opFront = _stencil$opFront === void 0 ? {\n          fail: gl.KEEP,\n          zfail: gl.KEEP,\n          zpass: gl.KEEP\n        } : _stencil$opFront,\n            _stencil$opBack = stencil.opBack,\n            opBack = _stencil$opBack === void 0 ? {\n          fail: gl.KEEP,\n          zfail: gl.KEEP,\n          zpass: gl.KEEP\n        } : _stencil$opBack;\n        drawParams.stencil = {\n          enable: !!enable,\n          mask: mask,\n          func: _objectSpread(_objectSpread({}, func), {}, {\n            cmp: stencilFuncMap[func.cmp]\n          }),\n          opFront: {\n            fail: stencilOpMap[opFront.fail],\n            zfail: stencilOpMap[opFront.zfail],\n            zpass: stencilOpMap[opFront.zpass]\n          },\n          opBack: {\n            fail: stencilOpMap[opBack.fail],\n            zfail: stencilOpMap[opBack.zfail],\n            zpass: stencilOpMap[opBack.zpass]\n          }\n        };\n      }\n    }\n  }, {\n    key: \"initCullDrawParams\",\n    value: function initCullDrawParams(_ref4, drawParams) {\n      var cull = _ref4.cull;\n\n      if (cull) {\n        var enable = cull.enable,\n            _cull$face = cull.face,\n            face = _cull$face === void 0 ? gl.BACK : _cull$face;\n        drawParams.cull = {\n          enable: !!enable,\n          face: cullFaceMap[face]\n        };\n      }\n    }\n  }, {\n    key: \"extractUniforms\",\n    value: function extractUniforms(uniforms) {\n      var _this = this;\n\n      var extractedUniforms = {};\n      Object.keys(uniforms).forEach(function (uniformName) {\n        _this.extractUniformsRecursively(uniformName, uniforms[uniformName], extractedUniforms, '');\n      });\n      return extractedUniforms;\n    }\n  }, {\n    key: \"extractUniformsRecursively\",\n    value: function extractUniformsRecursively(uniformName, uniformValue, uniforms, prefix) {\n      var _this2 = this;\n\n      if (uniformValue === null || typeof uniformValue === 'number' || typeof uniformValue === 'boolean' || Array.isArray(uniformValue) && typeof uniformValue[0] === 'number' || _isTypedArray(uniformValue) || uniformValue === '' || 'resize' in uniformValue) {\n        uniforms[\"\".concat(prefix && prefix + '.').concat(uniformName)] = uniformValue;\n        return;\n      }\n\n      if (_isPlainObject(uniformValue)) {\n        Object.keys(uniformValue).forEach(function (childName) {\n          _this2.extractUniformsRecursively(childName, uniformValue[childName], uniforms, \"\".concat(prefix && prefix + '.').concat(uniformName));\n        });\n      }\n\n      if (Array.isArray(uniformValue)) {\n        uniformValue.forEach(function (child, idx) {\n          Object.keys(child).forEach(function (childName) {\n            _this2.extractUniformsRecursively(childName, child[childName], uniforms, \"\".concat(prefix && prefix + '.').concat(uniformName, \"[\").concat(idx, \"]\"));\n          });\n        });\n      }\n    }\n  }]);\n\n  return ReglModel;\n}();\n\nexport { ReglModel as default };","map":{"version":3,"sources":["../../src/regl/ReglModel.ts"],"names":["ReglModel","vs","fs","attributes","uniforms","primitive","count","elements","depth","blend","stencil","cull","instances","options","reglUniforms","Object","reGl","reglAttributes","drawParams","frag","vert","primitiveMap","gl","reglDrawProps","type","Array","attr","enable","mask","func","depthFuncMap","range","equation","color","srcRGB","blendFuncMap","srcAlpha","dstRGB","dstAlpha","rgb","blendEquationMap","alpha","cmp","ref","opFront","fail","zfail","zpass","KEEP","opBack","stencilFuncMap","stencilOpMap","face","cullFaceMap","extractedUniforms","uniformValue","prefix","child"],"mappings":"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","sourcesContent":["import {\n  gl,\n  IAttribute,\n  IModel,\n  IModelDrawOptions,\n  IModelInitializationOptions,\n  IUniform,\n} from '@antv/l7-core';\nimport regl from 'l7regl';\nimport { isPlainObject, isTypedArray } from 'lodash';\nimport {\n  blendEquationMap,\n  blendFuncMap,\n  cullFaceMap,\n  depthFuncMap,\n  primitiveMap,\n  stencilFuncMap,\n  stencilOpMap,\n} from './constants';\nimport ReglAttribute from './ReglAttribute';\nimport ReglElements from './ReglElements';\nimport ReglFramebuffer from './ReglFramebuffer';\nimport ReglTexture2D from './ReglTexture2D';\n\n/**\n * adaptor for regl.DrawCommand\n */\nexport default class ReglModel implements IModel {\n  private reGl: regl.Regl;\n  private destroyed: boolean = false;\n  private drawCommand: regl.DrawCommand;\n  private drawParams: regl.DrawConfig;\n  private options: IModelInitializationOptions;\n  private uniforms: {\n    [key: string]: IUniform;\n  } = {};\n\n  constructor(reGl: regl.Regl, options: IModelInitializationOptions) {\n    this.reGl = reGl;\n    const {\n      vs,\n      fs,\n      attributes,\n      uniforms,\n      primitive,\n      count,\n      elements,\n      depth,\n      blend,\n      stencil,\n      cull,\n      instances,\n    } = options;\n    const reglUniforms: { [key: string]: IUniform } = {};\n    this.options = options;\n    if (uniforms) {\n      this.uniforms = this.extractUniforms(uniforms);\n      Object.keys(uniforms).forEach((uniformName) => {\n        // use regl prop API\n        // @ts-ignore\n        reglUniforms[uniformName] = reGl.prop(uniformName);\n      });\n    }\n\n    const reglAttributes: { [key: string]: regl.Attribute } = {};\n    Object.keys(attributes).forEach((name: string) => {\n      reglAttributes[name] = (attributes[name] as ReglAttribute).get();\n    });\n    const drawParams: regl.DrawConfig = {\n      attributes: reglAttributes,\n      frag: fs,\n      uniforms: reglUniforms,\n      vert: vs,\n      primitive:\n        primitiveMap[primitive === undefined ? gl.TRIANGLES : primitive],\n    };\n    if (instances) {\n      drawParams.instances = instances;\n    }\n\n    // elements 中可能包含 count，此时不应传入\n    if (count) {\n      drawParams.count = count;\n    }\n\n    if (elements) {\n      drawParams.elements = (elements as ReglElements).get();\n    }\n\n    this.initDepthDrawParams({ depth }, drawParams);\n    this.initBlendDrawParams({ blend }, drawParams);\n    this.initStencilDrawParams({ stencil }, drawParams);\n    this.initCullDrawParams({ cull }, drawParams);\n\n    this.drawCommand = reGl(drawParams);\n    this.drawParams = drawParams;\n  }\n\n  public addUniforms(uniforms: { [key: string]: IUniform }) {\n    this.uniforms = {\n      ...this.uniforms,\n      ...this.extractUniforms(uniforms),\n    };\n  }\n\n  public draw(options: IModelDrawOptions) {\n    if (\n      this.drawParams.attributes &&\n      Object.keys(this.drawParams.attributes).length === 0\n    ) {\n      return;\n    }\n    const uniforms: {\n      [key: string]: IUniform;\n    } = {\n      ...this.uniforms,\n      ...this.extractUniforms(options.uniforms || {}),\n    };\n    const reglDrawProps: {\n      [key: string]:\n        | regl.Framebuffer\n        | regl.Texture2D\n        | number\n        | number[]\n        | boolean;\n    } = {};\n    Object.keys(uniforms).forEach((uniformName: string) => {\n      const type = typeof uniforms[uniformName];\n      if (\n        type === 'boolean' ||\n        type === 'number' ||\n        Array.isArray(uniforms[uniformName]) ||\n        // @ts-ignore\n        uniforms[uniformName].BYTES_PER_ELEMENT\n      ) {\n        reglDrawProps[uniformName] = uniforms[uniformName] as\n          | number\n          | number[]\n          | boolean;\n      } else {\n        reglDrawProps[uniformName] = (uniforms[uniformName] as\n          | ReglFramebuffer\n          | ReglTexture2D).get();\n      }\n    });\n    this.drawCommand(reglDrawProps);\n  }\n\n  public destroy() {\n    // @ts-ignore\n    this.drawParams.elements.destroy();\n    if (this.options.attributes) {\n      Object.values(this.options.attributes).forEach((attr: any) => {\n        // @ts-ignore\n        (attr as ReglAttribute).destroy();\n      });\n    }\n    this.destroyed = true;\n  }\n\n  /**\n   * @see https://github.com/regl-project/regl/blob/gh-pages/API.md#depth-buffer\n   */\n  private initDepthDrawParams(\n    { depth }: Pick<IModelInitializationOptions, 'depth'>,\n    drawParams: regl.DrawConfig,\n  ) {\n    if (depth) {\n      drawParams.depth = {\n        enable: depth.enable === undefined ? true : !!depth.enable,\n        mask: depth.mask === undefined ? true : !!depth.mask,\n        func: depthFuncMap[depth.func || gl.LESS],\n        range: depth.range || [0, 1],\n      };\n    }\n  }\n\n  /**\n   * @see https://github.com/regl-project/regl/blob/gh-pages/API.md#blending\n   */\n  private initBlendDrawParams(\n    { blend }: Pick<IModelInitializationOptions, 'blend'>,\n    drawParams: regl.DrawConfig,\n  ) {\n    if (blend) {\n      const { enable, func, equation, color = [0, 0, 0, 0] } = blend;\n      // @ts-ignore\n      drawParams.blend = {\n        enable: !!enable,\n        func: {\n          srcRGB: blendFuncMap[(func && func.srcRGB) || gl.SRC_ALPHA],\n          srcAlpha: blendFuncMap[(func && func.srcAlpha) || gl.SRC_ALPHA],\n          dstRGB: blendFuncMap[(func && func.dstRGB) || gl.ONE_MINUS_SRC_ALPHA],\n          dstAlpha:\n            blendFuncMap[(func && func.dstAlpha) || gl.ONE_MINUS_SRC_ALPHA],\n        },\n        equation: {\n          rgb: blendEquationMap[(equation && equation.rgb) || gl.FUNC_ADD],\n          alpha: blendEquationMap[(equation && equation.alpha) || gl.FUNC_ADD],\n        },\n        color,\n      };\n    }\n  }\n\n  /**\n   * @see https://github.com/regl-project/regl/blob/gh-pages/API.md#stencil\n   */\n  private initStencilDrawParams(\n    { stencil }: Pick<IModelInitializationOptions, 'stencil'>,\n    drawParams: regl.DrawConfig,\n  ) {\n    if (stencil) {\n      const {\n        enable,\n        mask = -1,\n        func = {\n          cmp: gl.ALWAYS,\n          ref: 0,\n          mask: -1,\n        },\n        opFront = {\n          fail: gl.KEEP,\n          zfail: gl.KEEP,\n          zpass: gl.KEEP,\n        },\n        opBack = {\n          fail: gl.KEEP,\n          zfail: gl.KEEP,\n          zpass: gl.KEEP,\n        },\n      } = stencil;\n      drawParams.stencil = {\n        enable: !!enable,\n        mask,\n        func: {\n          ...func,\n          cmp: stencilFuncMap[func.cmp],\n        },\n        opFront: {\n          fail: stencilOpMap[opFront.fail],\n          zfail: stencilOpMap[opFront.zfail],\n          zpass: stencilOpMap[opFront.zpass],\n        },\n        opBack: {\n          fail: stencilOpMap[opBack.fail],\n          zfail: stencilOpMap[opBack.zfail],\n          zpass: stencilOpMap[opBack.zpass],\n        },\n      };\n    }\n  }\n\n  /**\n   * @see https://github.com/regl-project/regl/blob/gh-pages/API.md#culling\n   */\n  private initCullDrawParams(\n    { cull }: Pick<IModelInitializationOptions, 'cull'>,\n    drawParams: regl.DrawConfig,\n  ) {\n    if (cull) {\n      const { enable, face = gl.BACK } = cull;\n      drawParams.cull = {\n        enable: !!enable,\n        face: cullFaceMap[face],\n      };\n    }\n  }\n\n  /**\n   * 考虑结构体命名, eg:\n   * a: { b: 1 }  ->  'a.b'\n   * a: [ { b: 1 } ] -> 'a[0].b'\n   */\n  private extractUniforms(uniforms: {\n    [key: string]: IUniform;\n  }): {\n    [key: string]: IUniform;\n  } {\n    const extractedUniforms = {};\n    Object.keys(uniforms).forEach((uniformName) => {\n      this.extractUniformsRecursively(\n        uniformName,\n        uniforms[uniformName],\n        extractedUniforms,\n        '',\n      );\n    });\n\n    return extractedUniforms;\n  }\n\n  private extractUniformsRecursively(\n    uniformName: string,\n    uniformValue: IUniform,\n    uniforms: {\n      [key: string]: IUniform;\n    },\n    prefix: string,\n  ) {\n    if (\n      uniformValue === null ||\n      typeof uniformValue === 'number' || // u_A: 1\n      typeof uniformValue === 'boolean' || // u_A: false\n      (Array.isArray(uniformValue) && typeof uniformValue[0] === 'number') || // u_A: [1, 2, 3]\n      isTypedArray(uniformValue) || // u_A: Float32Array\n      // @ts-ignore\n      uniformValue === '' ||\n      'resize' in uniformValue\n    ) {\n      uniforms[`${prefix && prefix + '.'}${uniformName}`] = uniformValue;\n      return;\n    }\n\n    // u_Struct.a.b.c\n    if (isPlainObject(uniformValue)) {\n      Object.keys(uniformValue).forEach((childName) => {\n        this.extractUniformsRecursively(\n          childName,\n          // @ts-ignore\n          uniformValue[childName],\n          uniforms,\n          `${prefix && prefix + '.'}${uniformName}`,\n        );\n      });\n    }\n\n    // u_Struct[0].a\n    if (Array.isArray(uniformValue)) {\n      uniformValue.forEach((child, idx) => {\n        Object.keys(child).forEach((childName) => {\n          this.extractUniformsRecursively(\n            childName,\n            // @ts-ignore\n            child[childName],\n            uniforms,\n            `${prefix && prefix + '.'}${uniformName}[${idx}]`,\n          );\n        });\n      });\n    }\n  }\n}\n"]},"metadata":{},"sourceType":"module"}