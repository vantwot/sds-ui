{"ast":null,"code":"import _classCallCheck from \"/home/manolo/sds-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/home/manolo/sds-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _get from \"/home/manolo/sds-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/get\";\nimport _getPrototypeOf from \"/home/manolo/sds-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _inherits from \"/home/manolo/sds-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";\nimport _createSuper from \"/home/manolo/sds-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";\nimport _toConsumableArray from \"/home/manolo/sds-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";\nimport _slicedToArray from \"/home/manolo/sds-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";\n\nvar __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n      d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) {\n    if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  }\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\n\nimport React, { useState, useCallback, useLayoutEffect, useRef } from 'react';\nimport ReactDOM from 'react-dom';\nimport { NodeView } from '@antv/x6';\nimport { Wrap } from '../wrap';\nvar action = 'react';\nexport function createPortal(uniqViewId) {\n  var setGraphRef = {\n    current: function current() {}\n  };\n\n  var setGraph = function setGraph(graph) {\n    setGraphRef.current(graph);\n  };\n\n  var add;\n  var remove;\n\n  function connect(id, portal) {\n    add({\n      id: id,\n      portal: portal\n    });\n  }\n\n  function disconnect(id) {\n    remove(id);\n  }\n\n  var Portal = function Portal() {\n    var _useState = useState([]),\n        _useState2 = _slicedToArray(_useState, 2),\n        items = _useState2[0],\n        setItems = _useState2[1];\n\n    var _useState3 = useState(),\n        _useState4 = _slicedToArray(_useState3, 2),\n        graph = _useState4[0],\n        setGraphInstance = _useState4[1];\n\n    var pendingAddIdsRef = useRef([]);\n    var pendingAddItemsRef = useRef([]);\n    setGraphRef.current = setGraphInstance;\n    var addItem = useCallback(function (payload) {\n      var id = payload.id;\n\n      if (pendingAddIdsRef.current.includes(id)) {\n        // if in pendingAddIds queue\n        var itms = pendingAddItemsRef.current;\n        var matchIndex = itms.findIndex(function (item) {\n          return item.id === id;\n        });\n\n        if (matchIndex > -1) {\n          itms[matchIndex] = payload;\n        } else {\n          itms.push(payload);\n        }\n\n        pendingAddItemsRef.current = itms;\n      } else {\n        // if not in pendingAddIds queue\n        setItems(function (prevItems) {\n          var nextItems = _toConsumableArray(prevItems);\n\n          var matchIndex = nextItems.findIndex(function (item) {\n            return item.id === id;\n          });\n\n          if (matchIndex > -1) {\n            nextItems[matchIndex] = payload;\n          } else {\n            nextItems.push(payload);\n          }\n\n          return nextItems;\n        });\n      }\n    }, []);\n    add = addItem;\n    var removeItem = useCallback(function (id) {\n      if (pendingAddIdsRef.current.includes(id)) {\n        pendingAddIdsRef.current = pendingAddIdsRef.current.filter(function (cId) {\n          return cId !== id;\n        });\n      }\n\n      if (pendingAddItemsRef.current.map(function (c) {\n        return c.id;\n      }).includes(id)) {\n        pendingAddItemsRef.current = pendingAddItemsRef.current.filter(function (c) {\n          return c.id !== id;\n        });\n      }\n\n      setItems(function (itms) {\n        return itms.filter(function (item) {\n          return item.id !== id;\n        });\n      });\n    }, []);\n    remove = removeItem;\n    var startBatch = useCallback(function (args) {\n      var name = args.name,\n          data = args.data;\n\n      var _ref = data || {},\n          _ref$cells = _ref.cells,\n          cells = _ref$cells === void 0 ? [] : _ref$cells;\n\n      if (name === 'add') {\n        var cellIds = cells.filter(function (cell) {\n          return cell.isNode();\n        }).map(function (cell) {\n          return cell.id;\n        });\n        pendingAddIdsRef.current = Array.from(new Set([].concat(_toConsumableArray(pendingAddIdsRef.current), _toConsumableArray(cellIds))));\n      }\n    }, []);\n    var stopBatch = useCallback(function (_ref2) {\n      var name = _ref2.name;\n\n      if (name === 'add') {\n        var pendingAdds = pendingAddItemsRef.current;\n\n        if (pendingAdds.length) {\n          var currentPendingAddIds = pendingAdds.map(function (pendingAddItem) {\n            return pendingAddItem.id;\n          });\n          pendingAddIdsRef.current = pendingAddIdsRef.current.filter(function (id) {\n            return !currentPendingAddIds.includes(id);\n          });\n          pendingAddItemsRef.current = [];\n          setItems(function (prevItems) {\n            var nextItems = _toConsumableArray(prevItems);\n\n            pendingAdds.forEach(function (pendingAddItem) {\n              var matchIndex = nextItems.findIndex(function (item) {\n                return item.id === pendingAddItem.id;\n              });\n\n              if (matchIndex > -1) {\n                nextItems[matchIndex] = pendingAddItem;\n              } else {\n                nextItems.push(pendingAddItem);\n              }\n            });\n            return nextItems;\n          });\n        }\n      }\n    }, []);\n    useLayoutEffect(function () {\n      if (graph) {\n        graph.on('batch:start', startBatch);\n        graph.on('batch:stop', stopBatch);\n      }\n\n      return function () {\n        if (graph) {\n          graph.off('batch:start', startBatch);\n          graph.off('batch:stop', stopBatch);\n          setItems([]);\n          pendingAddIdsRef.current = [];\n          pendingAddItemsRef.current = [];\n        }\n      };\n    }, [graph, startBatch, stopBatch]);\n    return React.createElement.apply(React, [React.Fragment, null].concat(_toConsumableArray(items.map(function (item) {\n      return item.portal;\n    }))));\n  };\n\n  var ReactShapeView = /*#__PURE__*/function (_NodeView) {\n    _inherits(ReactShapeView, _NodeView);\n\n    var _super = _createSuper(ReactShapeView);\n\n    function ReactShapeView() {\n      _classCallCheck(this, ReactShapeView);\n\n      return _super.apply(this, arguments);\n    }\n\n    _createClass(ReactShapeView, [{\n      key: \"init\",\n      value: function init() {\n        var _this = this;\n\n        _get(_getPrototypeOf(ReactShapeView.prototype), \"init\", this).call(this);\n\n        this.cell.on('removed', function () {\n          disconnect(_this.cell.id);\n        });\n      }\n    }, {\n      key: \"getComponentContainer\",\n      value: function getComponentContainer() {\n        return this.cell.prop('useForeignObject') === false ? this.selectors.content : this.selectors.foContent;\n      }\n    }, {\n      key: \"confirmUpdate\",\n      value: function confirmUpdate(flag) {\n        var _this2 = this;\n\n        var ret = _get(_getPrototypeOf(ReactShapeView.prototype), \"confirmUpdate\", this).call(this, flag);\n\n        return this.handleAction(ret, action, function () {\n          return _this2.renderReactComponent();\n        });\n      }\n    }, {\n      key: \"renderReactComponent\",\n      value: function renderReactComponent() {\n        this.unmountReactComponent();\n        var root = this.getComponentContainer();\n        var node = this.cell;\n        var graph = this.graph;\n\n        if (root) {\n          var component = this.graph.hook.getReactComponent(node);\n          var elem = React.createElement(Wrap, {\n            graph: graph,\n            node: node,\n            component: component\n          });\n          connect(this.cell.id, ReactDOM.createPortal(elem, root));\n        }\n      }\n    }, {\n      key: \"unmountReactComponent\",\n      value: function unmountReactComponent() {\n        var root = this.getComponentContainer();\n\n        if (root) {\n          ReactDOM.unmountComponentAtNode(root);\n        }\n\n        return root;\n      }\n    }, {\n      key: \"onMouseDown\",\n      value: function onMouseDown(e, x, y) {\n        var target = e.target;\n        var tagName = target.tagName.toLowerCase();\n\n        if (tagName === 'input') {\n          var type = target.getAttribute('type');\n\n          if (type == null || ['text', 'password', 'number', 'email', 'search', 'tel', 'url'].includes(type)) {\n            return;\n          }\n        }\n\n        _get(_getPrototypeOf(ReactShapeView.prototype), \"onMouseDown\", this).call(this, e, x, y);\n      }\n    }, {\n      key: \"dispose\",\n      value: function dispose() {\n        disconnect(this.cell.id);\n        this.unmountReactComponent();\n      }\n    }]);\n\n    return ReactShapeView;\n  }(NodeView);\n\n  __decorate([NodeView.dispose()], ReactShapeView.prototype, \"dispose\", null);\n\n  ReactShapeView.config({\n    bootstrap: [action],\n    actions: {\n      component: action\n    }\n  });\n  NodeView.registry.register(uniqViewId, ReactShapeView, true);\n  return {\n    Portal: Portal,\n    setGraph: setGraph\n  };\n}\nexport function usePortal(uniqViewId) {\n  var initializedRef = useRef(false);\n\n  var _useState5 = useState(function () {\n    if (!initializedRef.current) {\n      initializedRef.current = true;\n      return createPortal(uniqViewId);\n    }\n\n    return {}; // won't be used\n  }),\n      _useState6 = _slicedToArray(_useState5, 1),\n      PortalContainer = _useState6[0];\n\n  return [PortalContainer.Portal, PortalContainer.setGraph];\n}","map":{"version":3,"sources":["../../src/usePortal/index.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\nimport React, { useState, useCallback, useLayoutEffect, useRef } from 'react';\nimport ReactDOM from 'react-dom';\nimport { NodeView } from '@antv/x6';\nimport { Wrap } from '../wrap';\nconst action = 'react';\nexport function createPortal(uniqViewId) {\n    const setGraphRef = { current: () => { } };\n    const setGraph = (graph) => {\n        setGraphRef.current(graph);\n    };\n    let add;\n    let remove;\n    function connect(id, portal) {\n        add({ id, portal });\n    }\n    function disconnect(id) {\n        remove(id);\n    }\n    const Portal = () => {\n        const [items, setItems] = useState([]);\n        const [graph, setGraphInstance] = useState();\n        const pendingAddIdsRef = useRef([]);\n        const pendingAddItemsRef = useRef([]);\n        setGraphRef.current = setGraphInstance;\n        const addItem = useCallback((payload) => {\n            const { id } = payload;\n            if (pendingAddIdsRef.current.includes(id)) {\n                // if in pendingAddIds queue\n                const itms = pendingAddItemsRef.current;\n                const matchIndex = itms.findIndex((item) => item.id === id);\n                if (matchIndex > -1) {\n                    itms[matchIndex] = payload;\n                }\n                else {\n                    itms.push(payload);\n                }\n                pendingAddItemsRef.current = itms;\n            }\n            else {\n                // if not in pendingAddIds queue\n                setItems((prevItems) => {\n                    const nextItems = [...prevItems];\n                    const matchIndex = nextItems.findIndex((item) => item.id === id);\n                    if (matchIndex > -1) {\n                        nextItems[matchIndex] = payload;\n                    }\n                    else {\n                        nextItems.push(payload);\n                    }\n                    return nextItems;\n                });\n            }\n        }, []);\n        add = addItem;\n        const removeItem = useCallback((id) => {\n            if (pendingAddIdsRef.current.includes(id)) {\n                pendingAddIdsRef.current = pendingAddIdsRef.current.filter((cId) => cId !== id);\n            }\n            if (pendingAddItemsRef.current.map((c) => c.id).includes(id)) {\n                pendingAddItemsRef.current = pendingAddItemsRef.current.filter((c) => c.id !== id);\n            }\n            setItems((itms) => itms.filter((item) => item.id !== id));\n        }, []);\n        remove = removeItem;\n        const startBatch = useCallback((args) => {\n            const { name, data } = args;\n            const { cells = [] } = data || {};\n            if (name === 'add') {\n                const cellIds = cells\n                    .filter((cell) => cell.isNode())\n                    .map((cell) => cell.id);\n                pendingAddIdsRef.current = Array.from(new Set([...pendingAddIdsRef.current, ...cellIds]));\n            }\n        }, []);\n        const stopBatch = useCallback(({ name }) => {\n            if (name === 'add') {\n                const pendingAdds = pendingAddItemsRef.current;\n                if (pendingAdds.length) {\n                    const currentPendingAddIds = pendingAdds.map((pendingAddItem) => pendingAddItem.id);\n                    pendingAddIdsRef.current = pendingAddIdsRef.current.filter((id) => !currentPendingAddIds.includes(id));\n                    pendingAddItemsRef.current = [];\n                    setItems((prevItems) => {\n                        const nextItems = [...prevItems];\n                        pendingAdds.forEach((pendingAddItem) => {\n                            const matchIndex = nextItems.findIndex((item) => item.id === pendingAddItem.id);\n                            if (matchIndex > -1) {\n                                nextItems[matchIndex] = pendingAddItem;\n                            }\n                            else {\n                                nextItems.push(pendingAddItem);\n                            }\n                        });\n                        return nextItems;\n                    });\n                }\n            }\n        }, []);\n        useLayoutEffect(() => {\n            if (graph) {\n                graph.on('batch:start', startBatch);\n                graph.on('batch:stop', stopBatch);\n            }\n            return () => {\n                if (graph) {\n                    graph.off('batch:start', startBatch);\n                    graph.off('batch:stop', stopBatch);\n                    setItems([]);\n                    pendingAddIdsRef.current = [];\n                    pendingAddItemsRef.current = [];\n                }\n            };\n        }, [graph, startBatch, stopBatch]);\n        return React.createElement(React.Fragment, null, ...items.map((item) => item.portal));\n    };\n    class ReactShapeView extends NodeView {\n        init() {\n            super.init();\n            this.cell.on('removed', () => {\n                disconnect(this.cell.id);\n            });\n        }\n        getComponentContainer() {\n            return this.cell.prop('useForeignObject') === false\n                ? this.selectors.content\n                : this.selectors.foContent;\n        }\n        confirmUpdate(flag) {\n            const ret = super.confirmUpdate(flag);\n            return this.handleAction(ret, action, () => this.renderReactComponent());\n        }\n        renderReactComponent() {\n            this.unmountReactComponent();\n            const root = this.getComponentContainer();\n            const node = this.cell;\n            const graph = this.graph;\n            if (root) {\n                const component = this.graph.hook.getReactComponent(node);\n                const elem = React.createElement(Wrap, { graph, node, component });\n                connect(this.cell.id, ReactDOM.createPortal(elem, root));\n            }\n        }\n        unmountReactComponent() {\n            const root = this.getComponentContainer();\n            if (root) {\n                ReactDOM.unmountComponentAtNode(root);\n            }\n            return root;\n        }\n        onMouseDown(e, x, y) {\n            const target = e.target;\n            const tagName = target.tagName.toLowerCase();\n            if (tagName === 'input') {\n                const type = target.getAttribute('type');\n                if (type == null ||\n                    [\n                        'text',\n                        'password',\n                        'number',\n                        'email',\n                        'search',\n                        'tel',\n                        'url',\n                    ].includes(type)) {\n                    return;\n                }\n            }\n            super.onMouseDown(e, x, y);\n        }\n        dispose() {\n            disconnect(this.cell.id);\n            this.unmountReactComponent();\n        }\n    }\n    __decorate([\n        NodeView.dispose()\n    ], ReactShapeView.prototype, \"dispose\", null);\n    ReactShapeView.config({\n        bootstrap: [action],\n        actions: {\n            component: action,\n        },\n    });\n    NodeView.registry.register(uniqViewId, ReactShapeView, true);\n    return { Portal, setGraph };\n}\nexport function usePortal(uniqViewId) {\n    const initializedRef = useRef(false);\n    const [PortalContainer] = useState(() => {\n        if (!initializedRef.current) {\n            initializedRef.current = true;\n            return createPortal(uniqViewId);\n        }\n        return {}; // won't be used\n    });\n    return [PortalContainer.Portal, PortalContainer.setGraph];\n}\n//# sourceMappingURL=index.js.map"]},"metadata":{},"sourceType":"module"}