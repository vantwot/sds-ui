{"ast":null,"code":"import _regeneratorRuntime from \"/home/manolo/sds-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";\nimport _slicedToArray from \"/home/manolo/sds-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nimport React from 'react';\nimport { RxModel, NsModel } from './rx-model';\n/** 判断model是否Mount */\n\nvar isRefMounted = function isRefMounted(ref) {\n  return ref && ref.current && ref.current.isMounted;\n};\n/** 用于判断model是否Mount */\n\n\nexport var useIsMountedRef = function useIsMountedRef() {\n  /** 记录当前组件的加载状态 */\n  var ref = React.useRef({\n    isMounted: true\n  });\n  React.useEffect(function () {\n    return function () {\n      ref.current.isMounted = false;\n    };\n  }, []);\n  return ref;\n};\n/** 判断model是否Mount */\n\nexport var useModel = function useModel(model) {\n  /** 记录当前组件的加载状态 */\n  var ref = useIsMountedRef();\n\n  var _React$useState = React.useState(model.getValue()),\n      _React$useState2 = _slicedToArray(_React$useState, 2),\n      state = _React$useState2[0],\n      setState = _React$useState2[1];\n\n  React.useEffect(function () {\n    var disposeable = model.watch(function (val) {\n      if (isRefMounted(ref)) {\n        setState(val);\n      }\n    });\n    return function () {\n      disposeable.dispose();\n    };\n    /* eslint-disable-next-line  */\n  }, [setState]);\n  var value = state;\n  var canRender = NsModel.isValidValue(value);\n  var setValue = React.useCallback(function (val) {\n    return model.setValue(val);\n  }, [model]);\n  return [value, setValue, canRender];\n};\n/** 在组件内部新建一个model */\n\nexport var createComponentModel = function createComponentModel(initialState) {\n  /* eslint-disable-next-line  */\n  var model = React.useMemo(function () {\n    return new RxModel(initialState);\n  }, []);\n  /** model 和 state 绑定触发view刷新 */\n\n  /* eslint-disable-next-line  */\n\n  var _useModel = useModel(model),\n      _useModel2 = _slicedToArray(_useModel, 3),\n      modelValue = _useModel2[0],\n      setModelValue = _useModel2[1],\n      canRender = _useModel2[2];\n  /** unMount时dispose */\n\n  /* eslint-disable-next-line  */\n\n\n  React.useEffect(function () {\n    return function () {\n      model.dispose();\n    };\n  }, [model]);\n  return [modelValue, setModelValue, model, canRender];\n};\n/**\n * useModelAsync：\n * watch model的值，\n * 把model的值通过useState和组件状态关联起来\n */\n\nexport var useModelAsync = function useModelAsync(args) {\n  var getModel = args.getModel,\n      initialState = args.initialState;\n  /** 记录当前组件的加载状态 */\n\n  var isMountedRef = useIsMountedRef();\n  var modelRef = React.useRef();\n  /** 订阅 model */\n\n  var _React$useState3 = React.useState(initialState),\n      _React$useState4 = _slicedToArray(_React$useState3, 2),\n      state = _React$useState4[0],\n      setState = _React$useState4[1];\n\n  React.useEffect(function () {\n    var d;\n    getModel().then(function (model) {\n      return __awaiter(void 0, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n        var newState;\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                modelRef.current = model;\n                _context.next = 3;\n                return model.getValidValue();\n\n              case 3:\n                newState = _context.sent;\n\n                if (isMountedRef.current.isMounted) {\n                  _context.next = 6;\n                  break;\n                }\n\n                return _context.abrupt(\"return\");\n\n              case 6:\n                setState(newState);\n                d = model.watch(function (val) {\n                  if (isMountedRef.current.isMounted) {\n                    setState(val);\n                  }\n                });\n\n              case 8:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee);\n      }));\n    });\n    return function () {\n      if (d && d.dispose) {\n        d.dispose();\n      }\n    };\n    /* eslint-disable-next-line  */\n  }, []);\n  return [state, setState, modelRef.current];\n};","map":{"version":3,"sources":["../../src/common/rx-model-hook.tsx"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nimport React from 'react';\nimport { RxModel, NsModel } from './rx-model';\n/** 判断model是否Mount */\nconst isRefMounted = (ref) => {\n    return ref && ref.current && ref.current.isMounted;\n};\n/** 用于判断model是否Mount */\nexport const useIsMountedRef = () => {\n    /** 记录当前组件的加载状态 */\n    const ref = React.useRef({ isMounted: true });\n    React.useEffect(() => {\n        return () => {\n            ref.current.isMounted = false;\n        };\n    }, []);\n    return ref;\n};\n/** 判断model是否Mount */\nexport const useModel = (model) => {\n    /** 记录当前组件的加载状态 */\n    const ref = useIsMountedRef();\n    const [state, setState] = React.useState(model.getValue());\n    React.useEffect(() => {\n        const disposeable = model.watch(val => {\n            if (isRefMounted(ref)) {\n                setState(val);\n            }\n        });\n        return () => {\n            disposeable.dispose();\n        };\n        /* eslint-disable-next-line  */\n    }, [setState]);\n    const value = state;\n    const canRender = NsModel.isValidValue(value);\n    const setValue = React.useCallback(val => model.setValue(val), [model]);\n    return [value, setValue, canRender];\n};\n/** 在组件内部新建一个model */\nexport const createComponentModel = (initialState) => {\n    /* eslint-disable-next-line  */\n    const model = React.useMemo(() => new RxModel(initialState), []);\n    /** model 和 state 绑定触发view刷新 */\n    /* eslint-disable-next-line  */\n    const [modelValue, setModelValue, canRender] = useModel(model);\n    /** unMount时dispose */\n    /* eslint-disable-next-line  */\n    React.useEffect(() => {\n        return () => {\n            model.dispose();\n        };\n    }, [model]);\n    return [modelValue, setModelValue, model, canRender];\n};\n/**\n * useModelAsync：\n * watch model的值，\n * 把model的值通过useState和组件状态关联起来\n */\nexport const useModelAsync = (args) => {\n    const { getModel, initialState } = args;\n    /** 记录当前组件的加载状态 */\n    const isMountedRef = useIsMountedRef();\n    const modelRef = React.useRef();\n    /** 订阅 model */\n    const [state, setState] = React.useState(initialState);\n    React.useEffect(() => {\n        let d;\n        getModel().then((model) => __awaiter(void 0, void 0, void 0, function* () {\n            modelRef.current = model;\n            const newState = yield model.getValidValue();\n            if (!isMountedRef.current.isMounted) {\n                return;\n            }\n            setState(newState);\n            d = model.watch(val => {\n                if (isMountedRef.current.isMounted) {\n                    setState(val);\n                }\n            });\n        }));\n        return () => {\n            if (d && d.dispose) {\n                d.dispose();\n            }\n        };\n        /* eslint-disable-next-line  */\n    }, []);\n    return [state, setState, modelRef.current];\n};\n//# sourceMappingURL=rx-model-hook.js.map"]},"metadata":{},"sourceType":"module"}