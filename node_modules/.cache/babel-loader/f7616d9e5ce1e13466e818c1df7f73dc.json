{"ast":null,"code":"import _toConsumableArray from \"@babel/runtime/helpers/toConsumableArray\";\nimport _classCallCheck from \"@babel/runtime/helpers/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/createClass\";\nimport _defineProperty from \"@babel/runtime/helpers/defineProperty\";\nimport _isNil from \"lodash/isNil\";\n\nvar StyleAttribute = function () {\n  function StyleAttribute(options) {\n    var _this = this;\n\n    _classCallCheck(this, StyleAttribute);\n\n    _defineProperty(this, \"name\", void 0);\n\n    _defineProperty(this, \"type\", void 0);\n\n    _defineProperty(this, \"scale\", void 0);\n\n    _defineProperty(this, \"descriptor\", void 0);\n\n    _defineProperty(this, \"featureBufferLayout\", []);\n\n    _defineProperty(this, \"needRescale\", false);\n\n    _defineProperty(this, \"needRemapping\", false);\n\n    _defineProperty(this, \"needRegenerateVertices\", false);\n\n    _defineProperty(this, \"featureRange\", {\n      startIndex: 0,\n      endIndex: Infinity\n    });\n\n    _defineProperty(this, \"vertexAttribute\", void 0);\n\n    _defineProperty(this, \"defaultCallback\", function (params) {\n      if (params.length === 0) {\n        var _this$scale;\n\n        return ((_this$scale = _this.scale) === null || _this$scale === void 0 ? void 0 : _this$scale.defaultValues) || [];\n      }\n\n      return params.map(function (param, idx) {\n        var _this$scale2;\n\n        var scaleFunc = (_this$scale2 = _this.scale) === null || _this$scale2 === void 0 ? void 0 : _this$scale2.scalers[idx].func;\n        var value = scaleFunc(param);\n        return value;\n      });\n    });\n\n    this.setProps(options);\n  }\n\n  _createClass(StyleAttribute, [{\n    key: \"setProps\",\n    value: function setProps(options) {\n      Object.assign(this, options);\n    }\n  }, {\n    key: \"mapping\",\n    value: function mapping(params) {\n      var _this$scale3;\n\n      if ((_this$scale3 = this.scale) !== null && _this$scale3 !== void 0 && _this$scale3.callback) {\n        var _this$scale4;\n\n        var ret = (_this$scale4 = this.scale) === null || _this$scale4 === void 0 ? void 0 : _this$scale4.callback.apply(_this$scale4, _toConsumableArray(params));\n\n        if (!_isNil(ret)) {\n          return [ret];\n        }\n      }\n\n      return this.defaultCallback(params);\n    }\n  }, {\n    key: \"resetDescriptor\",\n    value: function resetDescriptor() {\n      if (this.descriptor) {\n        this.descriptor.buffer.data = [];\n      }\n    }\n  }]);\n\n  return StyleAttribute;\n}();\n\nexport { StyleAttribute as default };","map":{"version":3,"sources":["../../../src/services/layer/StyleAttribute.ts"],"names":["StyleAttribute","startIndex","endIndex","Infinity","Object","ret","params","scaleFunc","value"],"mappings":";;;;;;IAiBqBA,c;AA6BnB,WAAA,cAAA,CAAA,OAAA,EAAoE;AAAA,QAAA,KAAA,GAAA,IAAA;;AAAA,IAAA,eAAA,CAAA,IAAA,EAAA,cAAA,CAAA;;AAAA,IAAA,eAAA,CAAA,IAAA,EAAA,MAAA,EAAA,KAAA,CAAA,CAAA;;AAAA,IAAA,eAAA,CAAA,IAAA,EAAA,MAAA,EAAA,KAAA,CAAA,CAAA;;AAAA,IAAA,eAAA,CAAA,IAAA,EAAA,OAAA,EAAA,KAAA,CAAA,CAAA;;AAAA,IAAA,eAAA,CAAA,IAAA,EAAA,YAAA,EAAA,KAAA,CAAA,CAAA;;AAAA,IAAA,eAAA,CAAA,IAAA,EAAA,qBAAA,EAX/D,EAW+D,CAAA;;AAAA,IAAA,eAAA,CAAA,IAAA,EAAA,aAAA,EATtC,KASsC,CAAA;;AAAA,IAAA,eAAA,CAAA,IAAA,EAAA,eAAA,EARpC,KAQoC,CAAA;;AAAA,IAAA,eAAA,CAAA,IAAA,EAAA,wBAAA,EAP3B,KAO2B,CAAA;;AAAA,IAAA,eAAA,CAAA,IAAA,EAAA,cAAA,EAN/B;AACnCC,MAAAA,UAAU,EADyB,CAAA;AAEnCC,MAAAA,QAAQ,EAAEC;AAFyB,KAM+B,CAAA;;AAAA,IAAA,eAAA,CAAA,IAAA,EAAA,iBAAA,EAAA,KAAA,CAAA,CAAA;;AAAA,IAAA,eAAA,CAAA,IAAA,EAAA,iBAAA,EA8B1C,UAAA,MAAA,EAAkC;AAE1D,UAAIG,MAAM,CAANA,MAAAA,KAAJ,CAAA,EAAyB;AAAA,YAAA,WAAA;;AACvB,eAAO,CAAA,CAAA,WAAA,GAAA,KAAI,CAAJ,KAAA,MAAA,IAAA,IAAA,WAAA,KAAA,KAAA,CAAA,GAAA,KAAA,CAAA,GAAA,WAAA,CAAA,aAAA,KAAP,EAAA;AACD;;AACD,aAAO,MAAM,CAAN,GAAA,CAAW,UAAA,KAAA,EAAA,GAAA,EAAgB;AAAA,YAAA,YAAA;;AAChC,YAAMC,SAAS,GAAA,CAAA,YAAA,GAAG,KAAI,CAAP,KAAA,MAAA,IAAA,IAAA,YAAA,KAAA,KAAA,CAAA,GAAA,KAAA,CAAA,GAAG,YAAA,CAAA,OAAA,CAAA,GAAA,EAAlB,IAAA;AAEA,YAAMC,KAAK,GAAGD,SAAS,CAAvB,KAAuB,CAAvB;AACA,eAAA,KAAA;AAJF,OAAO,CAAP;AAnCkE,KAAA,CAAA;;AAClE,SAAA,QAAA,CAAA,OAAA;AACD;;;;WAED,SAAA,QAAA,CAAA,OAAA,EAAwE;AACtEH,MAAAA,MAAM,CAANA,MAAAA,CAAAA,IAAAA,EAAAA,OAAAA;AACD;;;WAED,SAAA,OAAA,CAAA,MAAA,EAA6C;AAAA,UAAA,YAAA;;AAI3C,UAAA,CAAA,YAAA,GAAI,KAAJ,KAAA,MAAA,IAAA,IAAA,YAAA,KAAA,KAAA,CAAA,IAAI,YAAA,CAAJ,QAAA,EAA0B;AAAA,YAAA,YAAA;;AAExB,YAAMC,GAAG,GAAA,CAAA,YAAA,GAAG,KAAH,KAAA,MAAA,IAAA,IAAA,YAAA,KAAA,KAAA,CAAA,GAAA,KAAA,CAAA,GAAG,YAAA,CAAA,QAAA,CAAA,KAAA,CAAA,YAAA,EAAA,kBAAA,CAAZ,MAAY,CAAA,CAAZ;;AACA,YAAI,CAAC,MAAA,CAAL,GAAK,CAAL,EAAiB;AACf,iBAAO,CAAP,GAAO,CAAP;AACD;AACF;;AAGD,aAAO,KAAA,eAAA,CAAP,MAAO,CAAP;AACD;;;WAED,SAAA,eAAA,GAAyB;AACvB,UAAI,KAAJ,UAAA,EAAqB;AACnB,aAAA,UAAA,CAAA,MAAA,CAAA,IAAA,GAAA,EAAA;AACD;AACF;;;;;;SAzDkBL,c","sourcesContent":["import { isNil } from 'lodash';\nimport {\n  IAttributeScale,\n  IScaleOption,\n  IStyleAttribute,\n  StyleScaleType,\n} from '../layer/IStyleAttributeService';\nimport { IAttribute } from '../renderer/IAttribute';\nimport {\n  AttributeType,\n  IEncodeFeature,\n  IFeatureRange,\n  IStyleAttributeInitializationOptions,\n  IStyleScale,\n  IVertexAttributeDescriptor,\n} from './IStyleAttributeService';\n\nexport default class StyleAttribute implements IStyleAttribute {\n  public name: string;\n  public type: AttributeType;\n  public scale?: {\n    type: StyleScaleType.CONSTANT;\n    names: string[];\n    field: string | string[];\n    values: unknown[];\n    defaultValues: unknown[];\n    callback?: (...args: any[]) => [];\n    scalers?: IAttributeScale[];\n  };\n  public descriptor: IVertexAttributeDescriptor;\n  public featureBufferLayout: Array<{\n    feature: IEncodeFeature;\n    featureIdx: number;\n    bufferOffset: number;\n    length: number;\n  }> = [];\n\n  public needRescale: boolean = false;\n  public needRemapping: boolean = false;\n  public needRegenerateVertices: boolean = false;\n  public featureRange: IFeatureRange = {\n    startIndex: 0,\n    endIndex: Infinity,\n  };\n  public vertexAttribute: IAttribute;\n\n  constructor(options: Partial<IStyleAttributeInitializationOptions>) {\n    this.setProps(options);\n  }\n\n  public setProps(options: Partial<IStyleAttributeInitializationOptions>) {\n    Object.assign(this, options);\n  }\n\n  public mapping(params: unknown[]): unknown[] {\n    /**\n     * 当用户设置的 callback 返回 null 时, 应该返回默认 callback 中的值\n     */\n    if (this.scale?.callback) {\n      // 使用用户返回的值处理\n      const ret = this.scale?.callback(...params);\n      if (!isNil(ret)) {\n        return [ret];\n      }\n    }\n\n    // 没有 callback 或者用户 callback 返回值为空，则使用默认的逻辑处理\n    return this.defaultCallback(params);\n  }\n\n  public resetDescriptor() {\n    if (this.descriptor) {\n      this.descriptor.buffer.data = [];\n    }\n  }\n\n  private defaultCallback = (params: unknown[]): unknown[] => {\n    // 没有 params 的情况，是指没有指定 fields，直接返回配置的 values 常量\n    if (params.length === 0) {\n      return this.scale?.defaultValues || [];\n    }\n    return params.map((param, idx) => {\n      const scaleFunc = this.scale?.scalers![idx].func;\n      // @ts-ignore\n      const value = scaleFunc(param);\n      return value;\n    });\n  };\n}\n"]},"metadata":{},"sourceType":"module"}