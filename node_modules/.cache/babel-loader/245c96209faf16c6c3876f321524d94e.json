{"ast":null,"code":"var __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n      d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\n\nimport Mousetrap from 'mousetrap';\nimport { Dom, FunctionExt } from '../util';\nimport { Disposable } from '../common';\nexport class Keyboard extends Disposable {\n  constructor(options) {\n    super();\n    this.options = options;\n    const scroller = this.graph.scroller.widget;\n    this.container = scroller ? scroller.container : this.graph.container;\n\n    if (options.global) {\n      this.target = document;\n    } else {\n      this.target = this.container;\n\n      if (!this.disabled) {\n        // ensure the container focusable\n        this.target.setAttribute('tabindex', '-1');\n      } // change to mouseup event，prevent page stalling caused by focus\n\n\n      this.graph.on('cell:mouseup', this.focus, this);\n      this.graph.on('blank:mouseup', this.focus, this);\n    }\n\n    this.mousetrap = Keyboard.createMousetrap(this);\n  }\n\n  get graph() {\n    return this.options.graph;\n  }\n\n  get disabled() {\n    return this.options.enabled !== true;\n  }\n\n  enable() {\n    if (this.disabled) {\n      this.options.enabled = true;\n      this.graph.options.keyboard.enabled = true;\n\n      if (this.target instanceof HTMLElement) {\n        this.target.setAttribute('tabindex', '-1');\n      }\n    }\n  }\n\n  disable() {\n    if (!this.disabled) {\n      this.options.enabled = false;\n      this.graph.options.keyboard.enabled = false;\n\n      if (this.target instanceof HTMLElement) {\n        this.target.removeAttribute('tabindex');\n      }\n    }\n  }\n\n  on(keys, callback, action) {\n    this.mousetrap.bind(this.getKeys(keys), callback, action);\n  }\n\n  off(keys, action) {\n    this.mousetrap.unbind(this.getKeys(keys), action);\n  }\n\n  focus() {\n    const target = this.target;\n    target.focus({\n      preventScroll: true\n    });\n  }\n\n  getKeys(keys) {\n    return (Array.isArray(keys) ? keys : [keys]).map(key => this.formatkey(key));\n  }\n\n  formatkey(key) {\n    const formated = key.toLowerCase().replace(/\\s/g, '').replace('delete', 'del').replace('cmd', 'command');\n    const formatFn = this.options.format;\n\n    if (formatFn) {\n      return FunctionExt.call(formatFn, this.graph, formated);\n    }\n\n    return formated;\n  }\n\n  isGraphEvent(e) {\n    const target = e.srcElement || e.target;\n\n    if (target) {\n      if (target === this.target || target === document.body) {\n        return true;\n      }\n\n      return Dom.contains(this.container, target);\n    }\n\n    return false;\n  }\n\n  isEnabledForEvent(e) {\n    const allowed = !this.disabled && this.isGraphEvent(e);\n\n    if (allowed) {\n      const target = e.target;\n      const tagName = target && target.tagName.toLowerCase();\n      const code = e.keyCode || e.which;\n\n      if (tagName === 'input' && (code === 8 || code === 46)) {\n        return false;\n      }\n\n      if (this.options.guard) {\n        return FunctionExt.call(this.options.guard, this.graph, e);\n      }\n    }\n\n    return allowed;\n  }\n\n  dispose() {\n    this.mousetrap.reset();\n  }\n\n}\n\n__decorate([Disposable.dispose()], Keyboard.prototype, \"dispose\", null);\n\n(function (Keyboard) {\n  function createMousetrap(keyboard) {\n    const mousetrap = new Mousetrap(keyboard.target);\n    const stopCallback = mousetrap.stopCallback;\n\n    mousetrap.stopCallback = (e, elem, combo) => {\n      if (keyboard.isEnabledForEvent(e)) {\n        if (stopCallback) {\n          return stopCallback.call(mousetrap, e, elem, combo);\n        }\n\n        return false;\n      }\n\n      return true;\n    };\n\n    return mousetrap;\n  }\n\n  Keyboard.createMousetrap = createMousetrap;\n})(Keyboard || (Keyboard = {}));","map":{"version":3,"sources":["../../src/graph/keyboard.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\nimport Mousetrap from 'mousetrap';\nimport { Dom, FunctionExt } from '../util';\nimport { Disposable } from '../common';\nexport class Keyboard extends Disposable {\n    constructor(options) {\n        super();\n        this.options = options;\n        const scroller = this.graph.scroller.widget;\n        this.container = scroller ? scroller.container : this.graph.container;\n        if (options.global) {\n            this.target = document;\n        }\n        else {\n            this.target = this.container;\n            if (!this.disabled) {\n                // ensure the container focusable\n                this.target.setAttribute('tabindex', '-1');\n            }\n            // change to mouseup event，prevent page stalling caused by focus\n            this.graph.on('cell:mouseup', this.focus, this);\n            this.graph.on('blank:mouseup', this.focus, this);\n        }\n        this.mousetrap = Keyboard.createMousetrap(this);\n    }\n    get graph() {\n        return this.options.graph;\n    }\n    get disabled() {\n        return this.options.enabled !== true;\n    }\n    enable() {\n        if (this.disabled) {\n            this.options.enabled = true;\n            this.graph.options.keyboard.enabled = true;\n            if (this.target instanceof HTMLElement) {\n                this.target.setAttribute('tabindex', '-1');\n            }\n        }\n    }\n    disable() {\n        if (!this.disabled) {\n            this.options.enabled = false;\n            this.graph.options.keyboard.enabled = false;\n            if (this.target instanceof HTMLElement) {\n                this.target.removeAttribute('tabindex');\n            }\n        }\n    }\n    on(keys, callback, action) {\n        this.mousetrap.bind(this.getKeys(keys), callback, action);\n    }\n    off(keys, action) {\n        this.mousetrap.unbind(this.getKeys(keys), action);\n    }\n    focus() {\n        const target = this.target;\n        target.focus({\n            preventScroll: true,\n        });\n    }\n    getKeys(keys) {\n        return (Array.isArray(keys) ? keys : [keys]).map((key) => this.formatkey(key));\n    }\n    formatkey(key) {\n        const formated = key\n            .toLowerCase()\n            .replace(/\\s/g, '')\n            .replace('delete', 'del')\n            .replace('cmd', 'command');\n        const formatFn = this.options.format;\n        if (formatFn) {\n            return FunctionExt.call(formatFn, this.graph, formated);\n        }\n        return formated;\n    }\n    isGraphEvent(e) {\n        const target = (e.srcElement || e.target);\n        if (target) {\n            if (target === this.target || target === document.body) {\n                return true;\n            }\n            return Dom.contains(this.container, target);\n        }\n        return false;\n    }\n    isEnabledForEvent(e) {\n        const allowed = !this.disabled && this.isGraphEvent(e);\n        if (allowed) {\n            const target = e.target;\n            const tagName = target && target.tagName.toLowerCase();\n            const code = e.keyCode || e.which;\n            if (tagName === 'input' && (code === 8 || code === 46)) {\n                return false;\n            }\n            if (this.options.guard) {\n                return FunctionExt.call(this.options.guard, this.graph, e);\n            }\n        }\n        return allowed;\n    }\n    dispose() {\n        this.mousetrap.reset();\n    }\n}\n__decorate([\n    Disposable.dispose()\n], Keyboard.prototype, \"dispose\", null);\n(function (Keyboard) {\n    function createMousetrap(keyboard) {\n        const mousetrap = new Mousetrap(keyboard.target);\n        const stopCallback = mousetrap.stopCallback;\n        mousetrap.stopCallback = (e, elem, combo) => {\n            if (keyboard.isEnabledForEvent(e)) {\n                if (stopCallback) {\n                    return stopCallback.call(mousetrap, e, elem, combo);\n                }\n                return false;\n            }\n            return true;\n        };\n        return mousetrap;\n    }\n    Keyboard.createMousetrap = createMousetrap;\n})(Keyboard || (Keyboard = {}));\n//# sourceMappingURL=keyboard.js.map"]},"metadata":{},"sourceType":"module"}