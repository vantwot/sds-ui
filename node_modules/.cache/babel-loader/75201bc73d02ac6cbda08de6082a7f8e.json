{"ast":null,"code":"import _defineProperty from \"/home/manolo/sds-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/defineProperty\";\nimport _classCallCheck from \"/home/manolo/sds-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/home/manolo/sds-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";\n\nvar __rest = this && this.__rest || function (s, e) {\n  var t = {};\n\n  for (var p in s) {\n    if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];\n  }\n\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n    if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i])) t[p[i]] = s[p[i]];\n  }\n  return t;\n};\n\nimport { Dom, Vector } from '../../util';\nimport { View } from '../../view/view';\nimport { Point, Angle } from '../../geometry';\nexport var Handle = /*#__PURE__*/function () {\n  function Handle() {\n    _classCallCheck(this, Handle);\n  }\n\n  _createClass(Handle, [{\n    key: \"handleClassName\",\n    get: function get() {\n      return ClassNames.handle;\n    }\n  }, {\n    key: \"pie\",\n    get: function get() {\n      return Object.assign(Object.assign({}, Handle.defaultPieOptions), this.handleOptions.pie);\n    }\n  }, {\n    key: \"initHandles\",\n    value: function initHandles() {\n      var _this = this,\n          _this$delegateEvents;\n\n      this.handles = [];\n\n      if (this.handleOptions.handles) {\n        this.handleOptions.handles.forEach(function (handle) {\n          return _this.addHandle(handle);\n        });\n      }\n\n      if (this.handleOptions.type === 'pie') {\n        if (this.pie.toggles) {\n          var className = ClassNames.pieToggle;\n          this.$pieToggles = {};\n          this.pie.toggles.forEach(function (item) {\n            var $elem = _this.$('<div/>');\n\n            _this.applyAttrs($elem, item.attrs);\n\n            $elem.addClass(className).addClass(\"\".concat(className, \"-pos-\").concat(item.position || 'e')).attr('data-name', item.name).appendTo(_this.container);\n            _this.$pieToggles[item.name] = $elem;\n          });\n        }\n\n        this.setPieIcons();\n      }\n\n      if (this.$handleContainer) {\n        var type = this.handleOptions.type || 'surround';\n        this.$handleContainer.addClass(ClassNames.wrap).addClass(ClassNames.animate).addClass(\"\".concat(ClassNames.handle, \"-\").concat(type));\n      }\n\n      this.delegateEvents((_this$delegateEvents = {}, _defineProperty(_this$delegateEvents, \"mousedown .\".concat(ClassNames.handle), 'onHandleMouseDown'), _defineProperty(_this$delegateEvents, \"touchstart .\".concat(ClassNames.handle), 'onHandleMouseDown'), _defineProperty(_this$delegateEvents, \"mousedown .\".concat(ClassNames.pieToggle), 'onPieToggleMouseDown'), _defineProperty(_this$delegateEvents, \"touchstart .\".concat(ClassNames.pieToggle), 'onPieToggleMouseDown'), _this$delegateEvents));\n    }\n  }, {\n    key: \"onHandleMouseDown\",\n    value: function onHandleMouseDown(evt) {\n      var action = this.$(evt.currentTarget).closest(\".\".concat(ClassNames.handle)).attr('data-action');\n\n      if (action) {\n        evt.preventDefault();\n        evt.stopPropagation();\n        this.setEventData(evt, {\n          action: action,\n          clientX: evt.clientX,\n          clientY: evt.clientY,\n          startX: evt.clientX,\n          startY: evt.clientY\n        });\n\n        if (evt.type === 'mousedown' && evt.button === 2) {\n          this.triggerHandleAction(action, 'contextmenu', evt);\n        } else {\n          this.triggerHandleAction(action, 'mousedown', evt);\n          this.delegateDocumentEvents({\n            mousemove: 'onHandleMouseMove',\n            touchmove: 'onHandleMouseMove',\n            mouseup: 'onHandleMouseUp',\n            touchend: 'onHandleMouseUp',\n            touchcancel: 'onHandleMouseUp'\n          }, evt.data);\n        }\n      }\n    }\n  }, {\n    key: \"onHandleMouseMove\",\n    value: function onHandleMouseMove(evt) {\n      var data = this.getEventData(evt);\n      var action = data.action;\n\n      if (action) {\n        this.triggerHandleAction(action, 'mousemove', evt);\n      }\n    }\n  }, {\n    key: \"onHandleMouseUp\",\n    value: function onHandleMouseUp(evt) {\n      var data = this.getEventData(evt);\n      var action = data.action;\n\n      if (action) {\n        this.triggerHandleAction(action, 'mouseup', evt);\n        this.undelegateDocumentEvents();\n      }\n    }\n  }, {\n    key: \"triggerHandleAction\",\n    value: function triggerHandleAction(action, eventName, evt, args) {\n      evt.preventDefault();\n      evt.stopPropagation();\n      var e = this.normalizeEvent(evt);\n      var data = this.getEventData(e);\n      var local = this.graph.snapToGrid(e.clientX, e.clientY);\n      var origin = this.graph.snapToGrid(data.clientX, data.clientY);\n      var dx = local.x - origin.x;\n      var dy = local.y - origin.y;\n      this.trigger(\"action:\".concat(action, \":\").concat(eventName), Object.assign({\n        e: e,\n        dx: dx,\n        dy: dy,\n        x: local.x,\n        y: local.y,\n        offsetX: evt.clientX - data.startX,\n        offsetY: evt.clientY - data.startY\n      }, args));\n      data.clientX = evt.clientX;\n      data.clientY = evt.clientY;\n    }\n  }, {\n    key: \"onPieToggleMouseDown\",\n    value: function onPieToggleMouseDown(evt) {\n      evt.stopPropagation();\n      var name = this.$(evt.target).closest(\".\".concat(ClassNames.pieToggle)).attr('data-name');\n\n      if (!this.isOpen(name)) {\n        if (this.isOpen()) {\n          this.toggleState();\n        }\n      }\n\n      this.toggleState(name);\n    }\n  }, {\n    key: \"setPieIcons\",\n    value: function setPieIcons() {\n      var _this2 = this;\n\n      if (this.handleOptions.type === 'pie') {\n        this.$handleContainer.find(\".\".concat(ClassNames.handle)).each(function (_, elem) {\n          var $elem = _this2.$(elem);\n\n          var action = $elem.attr('data-action');\n          var className = ClassNames.pieSlice;\n\n          var handle = _this2.getHandle(action);\n\n          if (!handle || !handle.icon) {\n            var contect = window.getComputedStyle(elem, ':before').getPropertyValue('content');\n\n            if (contect && contect !== 'none') {\n              var $icons = $elem.find(\".\".concat(className, \"-txt\"));\n\n              if ($icons.length) {\n                Vector.create($icons[0]).text(contect.replace(/['\"]/g, ''));\n              }\n            }\n\n            var bgImg = $elem.css('background-image');\n\n            if (bgImg) {\n              var matches = bgImg.match(/url\\(['\"]?([^'\"]+)['\"]?\\)/);\n\n              if (matches) {\n                var href = matches[1];\n                var $imgs = $elem.find(\".\".concat(className, \"-img\"));\n\n                if ($imgs.length > 0) {\n                  Vector.create($imgs[0]).attr('xlink:href', href);\n                }\n              }\n            }\n          }\n        });\n      }\n    }\n  }, {\n    key: \"getHandleIdx\",\n    value: function getHandleIdx(name) {\n      return this.handles.findIndex(function (item) {\n        return item.name === name;\n      });\n    }\n  }, {\n    key: \"hasHandle\",\n    value: function hasHandle(name) {\n      return this.getHandleIdx(name) >= 0;\n    }\n  }, {\n    key: \"getHandle\",\n    value: function getHandle(name) {\n      return this.handles.find(function (item) {\n        return item.name === name;\n      });\n    }\n  }, {\n    key: \"renderHandle\",\n    value: function renderHandle(handle) {\n      var $handle = this.$('<div/>').addClass(\"\".concat(ClassNames.handle, \" \").concat(ClassNames.handle, \"-\").concat(handle.name)).attr('data-action', handle.name).prop('draggable', false);\n\n      if (this.handleOptions.type === 'pie') {\n        var index = this.getHandleIdx(handle.name);\n        var pie = this.pie;\n        var outerRadius = pie.outerRadius;\n        var innerRadius = pie.innerRadius;\n        var offset = (outerRadius + innerRadius) / 2;\n        var ratio = new Point(outerRadius, outerRadius);\n        var delta = Angle.toRad(pie.sliceAngle);\n        var curRad = index * delta + Angle.toRad(pie.startAngle);\n        var nextRad = curRad + delta;\n        var pathData = Dom.createSlicePathData(innerRadius, outerRadius, curRad, nextRad);\n        var vSvg = Vector.create('svg').addClass(\"\".concat(ClassNames.pieSlice, \"-svg\"));\n        var vPath = Vector.create('path').addClass(ClassNames.pieSlice).attr('d', pathData).translate(outerRadius, outerRadius);\n        var pos = Point.fromPolar(offset, -curRad - delta / 2, ratio).toJSON();\n        var iconSize = pie.iconSize;\n        var vImg = Vector.create('image').attr(pos).addClass(\"\".concat(ClassNames.pieSlice, \"-img\"));\n        pos.y = pos.y + iconSize - 2;\n        var vText = Vector.create('text', {\n          'font-size': iconSize\n        }).attr(pos).addClass(\"\".concat(ClassNames.pieSlice, \"-txt\"));\n        vImg.attr({\n          width: iconSize,\n          height: iconSize\n        });\n        vImg.translate(-iconSize / 2, -iconSize / 2);\n        vText.translate(-iconSize / 2, -iconSize / 2);\n        vSvg.append([vPath, vImg, vText]);\n        $handle.append(vSvg.node);\n      } else {\n        $handle.addClass(\"\".concat(ClassNames.handle, \"-pos-\").concat(handle.position));\n\n        if (handle.content) {\n          if (typeof handle.content === 'string') {\n            $handle.html(handle.content);\n          } else {\n            $handle.append(handle.content);\n          }\n        }\n      }\n\n      this.updateHandleIcon($handle, handle.icon);\n      this.applyAttrs($handle, handle.attrs);\n      return $handle;\n    }\n  }, {\n    key: \"addHandle\",\n    value: function addHandle(handle) {\n      var _this3 = this;\n\n      if (!this.hasHandle(handle.name)) {\n        this.handles.push(handle);\n        var events = handle.events;\n\n        if (events) {\n          Object.keys(events).forEach(function (action) {\n            var callback = events[action];\n            var name = \"action:\".concat(handle.name, \":\").concat(action);\n\n            if (typeof callback === 'string') {\n              _this3.on(name, _this3[callback], _this3);\n            } else {\n              _this3.on(name, callback);\n            }\n          });\n        }\n\n        if (this.$handleContainer) {\n          this.$handleContainer.append(this.renderHandle(handle));\n        }\n      }\n\n      return this;\n    }\n  }, {\n    key: \"addHandles\",\n    value: function addHandles(handles) {\n      var _this4 = this;\n\n      handles.forEach(function (handle) {\n        return _this4.addHandle(handle);\n      });\n      return this;\n    }\n  }, {\n    key: \"removeHandles\",\n    value: function removeHandles() {\n      while (this.handles.length) {\n        this.removeHandle(this.handles[0].name);\n      }\n\n      return this;\n    }\n  }, {\n    key: \"removeHandle\",\n    value: function removeHandle(name) {\n      var _this5 = this;\n\n      var index = this.getHandleIdx(name);\n      var handle = this.handles[index];\n\n      if (handle) {\n        if (handle.events) {\n          Object.keys(handle.events).forEach(function (event) {\n            _this5.off(\"action:\".concat(name, \":\").concat(event));\n          });\n        }\n\n        this.getHandleElem(name).remove();\n        this.handles.splice(index, 1);\n      }\n\n      return this;\n    }\n  }, {\n    key: \"changeHandle\",\n    value: function changeHandle(name, newHandle) {\n      var handle = this.getHandle(name);\n\n      if (handle) {\n        this.removeHandle(name);\n        this.addHandle(Object.assign(Object.assign({}, handle), newHandle));\n      }\n\n      return this;\n    }\n  }, {\n    key: \"toggleHandle\",\n    value: function toggleHandle(name, selected) {\n      var handle = this.getHandle(name);\n\n      if (handle) {\n        var $handle = this.getHandleElem(name);\n        var className = \"\".concat(ClassNames.handle, \"-selected\");\n\n        if (selected === undefined) {\n          selected = !$handle.hasClass(className); // eslint-disable-line\n        }\n\n        $handle.toggleClass(className, selected);\n        var icon = selected ? handle.iconSelected : handle.icon;\n\n        if (icon) {\n          this.updateHandleIcon($handle, icon);\n        }\n      }\n\n      return this;\n    }\n  }, {\n    key: \"selectHandle\",\n    value: function selectHandle(name) {\n      return this.toggleHandle(name, true);\n    }\n  }, {\n    key: \"deselectHandle\",\n    value: function deselectHandle(name) {\n      return this.toggleHandle(name, false);\n    }\n  }, {\n    key: \"deselectAllHandles\",\n    value: function deselectAllHandles() {\n      var _this6 = this;\n\n      this.handles.forEach(function (handle) {\n        return _this6.deselectHandle(handle.name);\n      });\n      return this;\n    }\n  }, {\n    key: \"getHandleElem\",\n    value: function getHandleElem(name) {\n      return this.$handleContainer.find(\".\".concat(ClassNames.handle, \"-\").concat(name));\n    }\n  }, {\n    key: \"updateHandleIcon\",\n    value: function updateHandleIcon($handle, icon) {\n      if (this.handleOptions.type === 'pie') {\n        var $icons = $handle.find(\".\".concat(ClassNames.pieSliceImg));\n        this.$($icons[0]).attr('xlink:href', icon || '');\n      } else {\n        $handle.css('background-image', icon ? \"url(\".concat(icon, \")\") : '');\n      }\n    }\n  }, {\n    key: \"isRendered\",\n    value: function isRendered() {\n      return this.$handleContainer != null;\n    }\n  }, {\n    key: \"isOpen\",\n    value: function isOpen(name) {\n      if (this.isRendered()) {\n        return name ? this.$pieToggles[name].hasClass(ClassNames.pieToggleOpened) : this.$handleContainer.hasClass(\"\".concat(ClassNames.pieOpended));\n      }\n\n      return false;\n    }\n  }, {\n    key: \"toggleState\",\n    value: function toggleState(name) {\n      var _this7 = this;\n\n      if (this.isRendered()) {\n        var $handleContainer = this.$handleContainer;\n        Object.keys(this.$pieToggles).forEach(function (key) {\n          var $toggle = _this7.$pieToggles[key];\n          $toggle.removeClass(ClassNames.pieToggleOpened);\n        });\n\n        if (this.isOpen()) {\n          this.trigger('pie:close', {\n            name: name\n          });\n          $handleContainer.removeClass(ClassNames.pieOpended);\n        } else {\n          this.trigger('pie:open', {\n            name: name\n          });\n\n          if (name) {\n            var toggles = this.pie.toggles;\n            var toggle = toggles && toggles.find(function (i) {\n              return i.name === name;\n            });\n\n            if (toggle) {\n              $handleContainer.attr({\n                'data-pie-toggle-name': toggle.name,\n                'data-pie-toggle-position': toggle.position\n              });\n            }\n\n            this.$pieToggles[name].addClass(ClassNames.pieToggleOpened);\n          }\n\n          $handleContainer.addClass(ClassNames.pieOpended);\n        }\n      }\n    }\n  }, {\n    key: \"applyAttrs\",\n    value: function applyAttrs(elem, attrs) {\n      if (attrs) {\n        var $elem = View.$(elem);\n        Object.keys(attrs).forEach(function (selector) {\n          var $element = $elem.find(selector).addBack().filter(selector);\n\n          var _a = attrs[selector],\n              cls = _a.class,\n              attr = __rest(_a, [\"class\"]);\n\n          if (cls) {\n            $element.addClass(cls);\n          }\n\n          $element.attr(attr);\n        });\n      }\n    }\n  }]);\n\n  return Handle;\n}();\n\n(function (Handle) {\n  Handle.defaultPieOptions = {\n    innerRadius: 20,\n    outerRadius: 50,\n    sliceAngle: 45,\n    startAngle: 0,\n    iconSize: 14,\n    toggles: [{\n      name: 'default',\n      position: 'e'\n    }]\n  };\n})(Handle || (Handle = {}));\n\nvar ClassNames;\n\n(function (ClassNames) {\n  ClassNames.handle = View.prototype.prefixClassName('widget-handle');\n  ClassNames.wrap = \"\".concat(ClassNames.handle, \"-wrap\");\n  ClassNames.animate = \"\".concat(ClassNames.handle, \"-animate\");\n  ClassNames.pieOpended = \"\".concat(ClassNames.handle, \"-pie-opened\");\n  ClassNames.pieToggle = \"\".concat(ClassNames.handle, \"-pie-toggle\");\n  ClassNames.pieToggleOpened = \"\".concat(ClassNames.handle, \"-pie-toggle-opened\");\n  ClassNames.pieSlice = \"\".concat(ClassNames.handle, \"-pie-slice\");\n  ClassNames.pieSliceImg = \"\".concat(ClassNames.handle, \"-pie-slice-img\");\n})(ClassNames || (ClassNames = {}));","map":{"version":3,"sources":["../../../src/addon/common/handle.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["var __rest = (this && this.__rest) || function (s, e) {\n    var t = {};\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\n        t[p] = s[p];\n    if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\n        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))\n                t[p[i]] = s[p[i]];\n        }\n    return t;\n};\nimport { Dom, Vector } from '../../util';\nimport { View } from '../../view/view';\nimport { Point, Angle } from '../../geometry';\nexport class Handle {\n    get handleClassName() {\n        return ClassNames.handle;\n    }\n    get pie() {\n        return Object.assign(Object.assign({}, Handle.defaultPieOptions), this.handleOptions.pie);\n    }\n    initHandles() {\n        this.handles = [];\n        if (this.handleOptions.handles) {\n            this.handleOptions.handles.forEach((handle) => this.addHandle(handle));\n        }\n        if (this.handleOptions.type === 'pie') {\n            if (this.pie.toggles) {\n                const className = ClassNames.pieToggle;\n                this.$pieToggles = {};\n                this.pie.toggles.forEach((item) => {\n                    const $elem = this.$('<div/>');\n                    this.applyAttrs($elem, item.attrs);\n                    $elem\n                        .addClass(className)\n                        .addClass(`${className}-pos-${item.position || 'e'}`)\n                        .attr('data-name', item.name)\n                        .appendTo(this.container);\n                    this.$pieToggles[item.name] = $elem;\n                });\n            }\n            this.setPieIcons();\n        }\n        if (this.$handleContainer) {\n            const type = this.handleOptions.type || 'surround';\n            this.$handleContainer\n                .addClass(ClassNames.wrap)\n                .addClass(ClassNames.animate)\n                .addClass(`${ClassNames.handle}-${type}`);\n        }\n        this.delegateEvents({\n            [`mousedown .${ClassNames.handle}`]: 'onHandleMouseDown',\n            [`touchstart .${ClassNames.handle}`]: 'onHandleMouseDown',\n            [`mousedown .${ClassNames.pieToggle}`]: 'onPieToggleMouseDown',\n            [`touchstart .${ClassNames.pieToggle}`]: 'onPieToggleMouseDown',\n        });\n    }\n    onHandleMouseDown(evt) {\n        const action = this.$(evt.currentTarget)\n            .closest(`.${ClassNames.handle}`)\n            .attr('data-action');\n        if (action) {\n            evt.preventDefault();\n            evt.stopPropagation();\n            this.setEventData(evt, {\n                action,\n                clientX: evt.clientX,\n                clientY: evt.clientY,\n                startX: evt.clientX,\n                startY: evt.clientY,\n            });\n            if (evt.type === 'mousedown' && evt.button === 2) {\n                this.triggerHandleAction(action, 'contextmenu', evt);\n            }\n            else {\n                this.triggerHandleAction(action, 'mousedown', evt);\n                this.delegateDocumentEvents({\n                    mousemove: 'onHandleMouseMove',\n                    touchmove: 'onHandleMouseMove',\n                    mouseup: 'onHandleMouseUp',\n                    touchend: 'onHandleMouseUp',\n                    touchcancel: 'onHandleMouseUp',\n                }, evt.data);\n            }\n        }\n    }\n    onHandleMouseMove(evt) {\n        const data = this.getEventData(evt);\n        const action = data.action;\n        if (action) {\n            this.triggerHandleAction(action, 'mousemove', evt);\n        }\n    }\n    onHandleMouseUp(evt) {\n        const data = this.getEventData(evt);\n        const action = data.action;\n        if (action) {\n            this.triggerHandleAction(action, 'mouseup', evt);\n            this.undelegateDocumentEvents();\n        }\n    }\n    triggerHandleAction(action, eventName, evt, args) {\n        evt.preventDefault();\n        evt.stopPropagation();\n        const e = this.normalizeEvent(evt);\n        const data = this.getEventData(e);\n        const local = this.graph.snapToGrid(e.clientX, e.clientY);\n        const origin = this.graph.snapToGrid(data.clientX, data.clientY);\n        const dx = local.x - origin.x;\n        const dy = local.y - origin.y;\n        this.trigger(`action:${action}:${eventName}`, Object.assign({ e,\n            dx,\n            dy, x: local.x, y: local.y, offsetX: evt.clientX - data.startX, offsetY: evt.clientY - data.startY }, args));\n        data.clientX = evt.clientX;\n        data.clientY = evt.clientY;\n    }\n    onPieToggleMouseDown(evt) {\n        evt.stopPropagation();\n        const name = this.$(evt.target)\n            .closest(`.${ClassNames.pieToggle}`)\n            .attr('data-name');\n        if (!this.isOpen(name)) {\n            if (this.isOpen()) {\n                this.toggleState();\n            }\n        }\n        this.toggleState(name);\n    }\n    setPieIcons() {\n        if (this.handleOptions.type === 'pie') {\n            this.$handleContainer.find(`.${ClassNames.handle}`).each((_, elem) => {\n                const $elem = this.$(elem);\n                const action = $elem.attr('data-action');\n                const className = ClassNames.pieSlice;\n                const handle = this.getHandle(action);\n                if (!handle || !handle.icon) {\n                    const contect = window\n                        .getComputedStyle(elem, ':before')\n                        .getPropertyValue('content');\n                    if (contect && contect !== 'none') {\n                        const $icons = $elem.find(`.${className}-txt`);\n                        if ($icons.length) {\n                            Vector.create($icons[0]).text(contect.replace(/['\"]/g, ''));\n                        }\n                    }\n                    const bgImg = $elem.css('background-image');\n                    if (bgImg) {\n                        const matches = bgImg.match(/url\\(['\"]?([^'\"]+)['\"]?\\)/);\n                        if (matches) {\n                            const href = matches[1];\n                            const $imgs = $elem.find(`.${className}-img`);\n                            if ($imgs.length > 0) {\n                                Vector.create($imgs[0]).attr('xlink:href', href);\n                            }\n                        }\n                    }\n                }\n            });\n        }\n    }\n    getHandleIdx(name) {\n        return this.handles.findIndex((item) => item.name === name);\n    }\n    hasHandle(name) {\n        return this.getHandleIdx(name) >= 0;\n    }\n    getHandle(name) {\n        return this.handles.find((item) => item.name === name);\n    }\n    renderHandle(handle) {\n        const $handle = this.$('<div/>')\n            .addClass(`${ClassNames.handle} ${ClassNames.handle}-${handle.name}`)\n            .attr('data-action', handle.name)\n            .prop('draggable', false);\n        if (this.handleOptions.type === 'pie') {\n            const index = this.getHandleIdx(handle.name);\n            const pie = this.pie;\n            const outerRadius = pie.outerRadius;\n            const innerRadius = pie.innerRadius;\n            const offset = (outerRadius + innerRadius) / 2;\n            const ratio = new Point(outerRadius, outerRadius);\n            const delta = Angle.toRad(pie.sliceAngle);\n            const curRad = index * delta + Angle.toRad(pie.startAngle);\n            const nextRad = curRad + delta;\n            const pathData = Dom.createSlicePathData(innerRadius, outerRadius, curRad, nextRad);\n            const vSvg = Vector.create('svg').addClass(`${ClassNames.pieSlice}-svg`);\n            const vPath = Vector.create('path')\n                .addClass(ClassNames.pieSlice)\n                .attr('d', pathData)\n                .translate(outerRadius, outerRadius);\n            const pos = Point.fromPolar(offset, -curRad - delta / 2, ratio).toJSON();\n            const iconSize = pie.iconSize;\n            const vImg = Vector.create('image')\n                .attr(pos)\n                .addClass(`${ClassNames.pieSlice}-img`);\n            pos.y = pos.y + iconSize - 2;\n            const vText = Vector.create('text', { 'font-size': iconSize })\n                .attr(pos)\n                .addClass(`${ClassNames.pieSlice}-txt`);\n            vImg.attr({\n                width: iconSize,\n                height: iconSize,\n            });\n            vImg.translate(-iconSize / 2, -iconSize / 2);\n            vText.translate(-iconSize / 2, -iconSize / 2);\n            vSvg.append([vPath, vImg, vText]);\n            $handle.append(vSvg.node);\n        }\n        else {\n            $handle.addClass(`${ClassNames.handle}-pos-${handle.position}`);\n            if (handle.content) {\n                if (typeof handle.content === 'string') {\n                    $handle.html(handle.content);\n                }\n                else {\n                    $handle.append(handle.content);\n                }\n            }\n        }\n        this.updateHandleIcon($handle, handle.icon);\n        this.applyAttrs($handle, handle.attrs);\n        return $handle;\n    }\n    addHandle(handle) {\n        if (!this.hasHandle(handle.name)) {\n            this.handles.push(handle);\n            const events = handle.events;\n            if (events) {\n                Object.keys(events).forEach((action) => {\n                    const callback = events[action];\n                    const name = `action:${handle.name}:${action}`;\n                    if (typeof callback === 'string') {\n                        this.on(name, this[callback], this);\n                    }\n                    else {\n                        this.on(name, callback);\n                    }\n                });\n            }\n            if (this.$handleContainer) {\n                this.$handleContainer.append(this.renderHandle(handle));\n            }\n        }\n        return this;\n    }\n    addHandles(handles) {\n        handles.forEach((handle) => this.addHandle(handle));\n        return this;\n    }\n    removeHandles() {\n        while (this.handles.length) {\n            this.removeHandle(this.handles[0].name);\n        }\n        return this;\n    }\n    removeHandle(name) {\n        const index = this.getHandleIdx(name);\n        const handle = this.handles[index];\n        if (handle) {\n            if (handle.events) {\n                Object.keys(handle.events).forEach((event) => {\n                    this.off(`action:${name}:${event}`);\n                });\n            }\n            this.getHandleElem(name).remove();\n            this.handles.splice(index, 1);\n        }\n        return this;\n    }\n    changeHandle(name, newHandle) {\n        const handle = this.getHandle(name);\n        if (handle) {\n            this.removeHandle(name);\n            this.addHandle(Object.assign(Object.assign({}, handle), newHandle));\n        }\n        return this;\n    }\n    toggleHandle(name, selected) {\n        const handle = this.getHandle(name);\n        if (handle) {\n            const $handle = this.getHandleElem(name);\n            const className = `${ClassNames.handle}-selected`;\n            if (selected === undefined) {\n                selected = !$handle.hasClass(className); // eslint-disable-line\n            }\n            $handle.toggleClass(className, selected);\n            const icon = selected ? handle.iconSelected : handle.icon;\n            if (icon) {\n                this.updateHandleIcon($handle, icon);\n            }\n        }\n        return this;\n    }\n    selectHandle(name) {\n        return this.toggleHandle(name, true);\n    }\n    deselectHandle(name) {\n        return this.toggleHandle(name, false);\n    }\n    deselectAllHandles() {\n        this.handles.forEach((handle) => this.deselectHandle(handle.name));\n        return this;\n    }\n    getHandleElem(name) {\n        return this.$handleContainer.find(`.${ClassNames.handle}-${name}`);\n    }\n    updateHandleIcon($handle, icon) {\n        if (this.handleOptions.type === 'pie') {\n            const $icons = $handle.find(`.${ClassNames.pieSliceImg}`);\n            this.$($icons[0]).attr('xlink:href', icon || '');\n        }\n        else {\n            $handle.css('background-image', icon ? `url(${icon})` : '');\n        }\n    }\n    isRendered() {\n        return this.$handleContainer != null;\n    }\n    isOpen(name) {\n        if (this.isRendered()) {\n            return name\n                ? this.$pieToggles[name].hasClass(ClassNames.pieToggleOpened)\n                : this.$handleContainer.hasClass(`${ClassNames.pieOpended}`);\n        }\n        return false;\n    }\n    toggleState(name) {\n        if (this.isRendered()) {\n            const $handleContainer = this.$handleContainer;\n            Object.keys(this.$pieToggles).forEach((key) => {\n                const $toggle = this.$pieToggles[key];\n                $toggle.removeClass(ClassNames.pieToggleOpened);\n            });\n            if (this.isOpen()) {\n                this.trigger('pie:close', { name });\n                $handleContainer.removeClass(ClassNames.pieOpended);\n            }\n            else {\n                this.trigger('pie:open', { name });\n                if (name) {\n                    const toggles = this.pie.toggles;\n                    const toggle = toggles && toggles.find((i) => i.name === name);\n                    if (toggle) {\n                        $handleContainer.attr({\n                            'data-pie-toggle-name': toggle.name,\n                            'data-pie-toggle-position': toggle.position,\n                        });\n                    }\n                    this.$pieToggles[name].addClass(ClassNames.pieToggleOpened);\n                }\n                $handleContainer.addClass(ClassNames.pieOpended);\n            }\n        }\n    }\n    applyAttrs(elem, attrs) {\n        if (attrs) {\n            const $elem = View.$(elem);\n            Object.keys(attrs).forEach((selector) => {\n                const $element = $elem.find(selector).addBack().filter(selector);\n                const _a = attrs[selector], { class: cls } = _a, attr = __rest(_a, [\"class\"]);\n                if (cls) {\n                    $element.addClass(cls);\n                }\n                $element.attr(attr);\n            });\n        }\n    }\n}\n(function (Handle) {\n    Handle.defaultPieOptions = {\n        innerRadius: 20,\n        outerRadius: 50,\n        sliceAngle: 45,\n        startAngle: 0,\n        iconSize: 14,\n        toggles: [\n            {\n                name: 'default',\n                position: 'e',\n            },\n        ],\n    };\n})(Handle || (Handle = {}));\nvar ClassNames;\n(function (ClassNames) {\n    ClassNames.handle = View.prototype.prefixClassName('widget-handle');\n    ClassNames.wrap = `${ClassNames.handle}-wrap`;\n    ClassNames.animate = `${ClassNames.handle}-animate`;\n    ClassNames.pieOpended = `${ClassNames.handle}-pie-opened`;\n    ClassNames.pieToggle = `${ClassNames.handle}-pie-toggle`;\n    ClassNames.pieToggleOpened = `${ClassNames.handle}-pie-toggle-opened`;\n    ClassNames.pieSlice = `${ClassNames.handle}-pie-slice`;\n    ClassNames.pieSliceImg = `${ClassNames.handle}-pie-slice-img`;\n})(ClassNames || (ClassNames = {}));\n//# sourceMappingURL=handle.js.map"]},"metadata":{},"sourceType":"module"}