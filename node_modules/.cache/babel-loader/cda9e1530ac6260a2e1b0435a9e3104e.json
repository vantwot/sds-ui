{"ast":null,"code":"var __extends = this && this.__extends || function () {\n  var _extendStatics = function extendStatics(d, b) {\n    _extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) {\n        if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p];\n      }\n    };\n\n    return _extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    if (typeof b !== \"function\" && b !== null) throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n\n    _extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nimport Base from '../base';\n\nfunction getEucliDis(pointA, pointB, eps) {\n  var vx = pointA.x - pointB.x;\n  var vy = pointA.y - pointB.y;\n\n  if (!eps || Math.abs(vx) > eps || Math.abs(vy) > eps) {\n    return Math.sqrt(vx * vx + vy * vy);\n  }\n\n  return eps;\n}\n\nfunction getDotProduct(ei, ej) {\n  return ei.x * ej.x + ei.y * ej.y;\n}\n\nfunction projectPointToEdge(p, e) {\n  var k = (e.source.y - e.target.y) / (e.source.x - e.target.x);\n  var x = (k * k * e.source.x + k * (p.y - e.source.y) + p.x) / (k * k + 1);\n  var y = k * (x - e.source.x) + e.source.y;\n  return {\n    x: x,\n    y: y\n  };\n}\n\nvar Bundling =\n/** @class */\nfunction (_super) {\n  __extends(Bundling, _super);\n\n  function Bundling(config) {\n    return _super.call(this, config) || this;\n  }\n\n  Bundling.prototype.getDefaultCfgs = function () {\n    return {\n      edgeBundles: [],\n      edgePoints: [],\n      K: 0.1,\n      lambda: 0.1,\n      divisions: 1,\n      divRate: 2,\n      cycles: 6,\n      iterations: 90,\n      iterRate: 0.6666667,\n      bundleThreshold: 0.6,\n      eps: 1e-6,\n      onLayoutEnd: function onLayoutEnd() {},\n      onTick: function onTick() {}\n    };\n  };\n\n  Bundling.prototype.init = function () {\n    var graph = this.get('graph');\n    var onTick = this.get('onTick');\n\n    var tick = function tick() {\n      if (onTick) {\n        onTick();\n      }\n\n      graph.refreshPositions();\n    };\n\n    this.set('tick', tick);\n  };\n\n  Bundling.prototype.bundling = function (data) {\n    var self = this;\n    self.set('data', data); // 如果正在布局，忽略布局请求\n\n    if (self.isTicking()) {\n      return;\n    }\n\n    var edges = data.edges || [];\n    var nodes = data.nodes || [];\n    var nodeIdMap = {};\n    var error = false;\n    nodes.forEach(function (node) {\n      if (node.x === null || !node.y === null || node.x === undefined || !node.y === undefined) {\n        error = true;\n      }\n\n      nodeIdMap[node.id] = node;\n    });\n    if (error) throw new Error('please layout the graph or assign x and y for nodes first');\n    self.set('nodeIdMap', nodeIdMap); // subdivide each edges\n\n    var divisions = self.get('divisions');\n    var divRate = self.get('divRate');\n    var edgePoints = self.divideEdges(divisions);\n    self.set('edgePoints', edgePoints); // compute the bundles\n\n    var edgeBundles = self.getEdgeBundles();\n    self.set('edgeBundles', edgeBundles); // iterations\n\n    var C = self.get('cycles');\n    var iterations = self.get('iterations');\n    var iterRate = self.get('iterRate');\n    var lambda = self.get('lambda');\n\n    for (var i = 0; i < C; i++) {\n      var _loop_1 = function _loop_1(j) {\n        var forces = [];\n        edges.forEach(function (e, k) {\n          if (e.source === e.target) return;\n          var source = nodeIdMap[e.source];\n          var target = nodeIdMap[e.target];\n          forces[k] = self.getEdgeForces({\n            source: source,\n            target: target\n          }, k, divisions, lambda);\n\n          for (var p = 0; p < divisions + 1; p++) {\n            edgePoints[k][p].x += forces[k][p].x;\n            edgePoints[k][p].y += forces[k][p].y;\n          }\n        });\n      };\n\n      for (var j = 0; j < iterations; j++) {\n        _loop_1(j);\n      } // parameters for nex cycle\n\n\n      lambda = lambda / 2;\n      divisions *= divRate;\n      iterations *= iterRate;\n      edgePoints = self.divideEdges(divisions);\n      self.set('edgePoints', edgePoints);\n    } // change the edges according to edgePoints\n\n\n    edges.forEach(function (e, i) {\n      if (e.source === e.target) return;\n      e.type = 'polyline';\n      e.controlPoints = edgePoints[i].slice(1, edgePoints[i].length - 1);\n    });\n    var graph = self.get('graph');\n    graph.refresh();\n  };\n\n  Bundling.prototype.updateBundling = function (cfg) {\n    var self = this;\n    var data = cfg.data;\n\n    if (data) {\n      self.set('data', data);\n    }\n\n    if (self.get('ticking')) {\n      self.set('ticking', false);\n    }\n\n    Object.keys(cfg).forEach(function (key) {\n      self.set(key, cfg[key]);\n    });\n\n    if (cfg.onTick) {\n      var graph_1 = this.get('graph');\n      self.set('tick', function () {\n        cfg.onTick();\n        graph_1.refresh();\n      });\n    }\n\n    self.bundling(data);\n  };\n\n  Bundling.prototype.divideEdges = function (divisions) {\n    var self = this;\n    var edges = self.get('data').edges;\n    var nodeIdMap = self.get('nodeIdMap');\n    var edgePoints = self.get('edgePoints');\n    if (!edgePoints || edgePoints === undefined) edgePoints = [];\n    edges.forEach(function (edge, i) {\n      if (!edgePoints[i] || edgePoints[i] === undefined) {\n        edgePoints[i] = [];\n      }\n\n      var source = nodeIdMap[edge.source];\n      var target = nodeIdMap[edge.target];\n\n      if (divisions === 1) {\n        edgePoints[i].push({\n          x: source.x,\n          y: source.y\n        }); // source\n\n        edgePoints[i].push({\n          x: 0.5 * (source.x + target.x),\n          y: 0.5 * (source.y + target.y)\n        }); // mid\n\n        edgePoints[i].push({\n          x: target.x,\n          y: target.y\n        }); // target\n      } else {\n        var edgeLength = 0;\n\n        if (!edgePoints[i] || edgePoints[i] === []) {\n          // it is a straight line\n          edgeLength = getEucliDis({\n            x: source.x,\n            y: source.y\n          }, {\n            x: target.x,\n            y: target.y\n          });\n        } else {\n          edgeLength = self.getEdgeLength(edgePoints[i]);\n        }\n\n        var divisionLength_1 = edgeLength / (divisions + 1);\n        var currentDivisonLength_1 = divisionLength_1;\n        var newEdgePoints_1 = [{\n          x: source.x,\n          y: source.y\n        }]; // source\n\n        edgePoints[i].forEach(function (ep, j) {\n          if (j === 0) return;\n          var oriDivisionLength = getEucliDis(ep, edgePoints[i][j - 1]);\n\n          while (oriDivisionLength > currentDivisonLength_1) {\n            var ratio = currentDivisonLength_1 / oriDivisionLength;\n            var edgePoint = {\n              x: edgePoints[i][j - 1].x,\n              y: edgePoints[i][j - 1].y\n            };\n            edgePoint.x += ratio * (ep.x - edgePoints[i][j - 1].x);\n            edgePoint.y += ratio * (ep.y - edgePoints[i][j - 1].y);\n            newEdgePoints_1.push(edgePoint);\n            oriDivisionLength -= currentDivisonLength_1;\n            currentDivisonLength_1 = divisionLength_1;\n          }\n\n          currentDivisonLength_1 -= oriDivisionLength;\n        });\n        newEdgePoints_1.push({\n          x: target.x,\n          y: target.y\n        }); // target\n\n        edgePoints[i] = newEdgePoints_1;\n      }\n    });\n    return edgePoints;\n  };\n  /**\n   * 计算边的长度\n   * @param points\n   */\n\n\n  Bundling.prototype.getEdgeLength = function (points) {\n    var length = 0;\n    points.forEach(function (p, i) {\n      if (i === 0) return;\n      length += getEucliDis(p, points[i - 1]);\n    });\n    return length;\n  };\n\n  Bundling.prototype.getEdgeBundles = function () {\n    var self = this;\n    var data = self.get('data');\n    var edges = data.edges || [];\n    var bundleThreshold = self.get('bundleThreshold');\n    var nodeIdMap = self.get('nodeIdMap');\n    var edgeBundles = self.get('edgeBundles');\n    if (!edgeBundles) edgeBundles = [];\n    edges.forEach(function (e, i) {\n      if (!edgeBundles[i] || edgeBundles[i] === undefined) {\n        edgeBundles[i] = [];\n      }\n    });\n    edges.forEach(function (ei, i) {\n      var iSource = nodeIdMap[ei.source];\n      var iTarget = nodeIdMap[ei.target];\n      edges.forEach(function (ej, j) {\n        if (j <= i) return;\n        var jSource = nodeIdMap[ej.source];\n        var jTarget = nodeIdMap[ej.target];\n        var score = self.getBundleScore({\n          source: iSource,\n          target: iTarget\n        }, {\n          source: jSource,\n          target: jTarget\n        });\n\n        if (score >= bundleThreshold) {\n          edgeBundles[i].push(j);\n          edgeBundles[j].push(i);\n        }\n      });\n    });\n    return edgeBundles;\n  };\n\n  Bundling.prototype.getBundleScore = function (ei, ej) {\n    var self = this;\n    ei.vx = ei.target.x - ei.source.x;\n    ei.vy = ei.target.y - ei.source.y;\n    ej.vx = ej.target.x - ej.source.x;\n    ej.vy = ej.target.y - ej.source.y;\n    ei.length = getEucliDis({\n      x: ei.source.x,\n      y: ei.source.y\n    }, {\n      x: ei.target.x,\n      y: ei.target.y\n    });\n    ej.length = getEucliDis({\n      x: ej.source.x,\n      y: ej.source.y\n    }, {\n      x: ej.target.x,\n      y: ej.target.y\n    }); // angle score\n\n    var aScore = self.getAngleScore(ei, ej); // scale score\n\n    var sScore = self.getScaleScore(ei, ej); // position score\n\n    var pScore = self.getPositionScore(ei, ej); // visibility socre\n\n    var vScore = self.getVisibilityScore(ei, ej);\n    return aScore * sScore * pScore * vScore;\n  };\n\n  Bundling.prototype.getAngleScore = function (ei, ej) {\n    var dotProduct = getDotProduct({\n      x: ei.vx,\n      y: ei.vy\n    }, {\n      x: ej.vx,\n      y: ej.vy\n    });\n    return dotProduct / (ei.length * ej.length);\n  };\n\n  Bundling.prototype.getScaleScore = function (ei, ej) {\n    var aLength = (ei.length + ej.length) / 2;\n    var score = 2 / (aLength / Math.min(ei.length, ej.length) + Math.max(ei.length, ej.length) / aLength);\n    return score;\n  };\n\n  Bundling.prototype.getPositionScore = function (ei, ej) {\n    var aLength = (ei.length + ej.length) / 2;\n    var iMid = {\n      x: (ei.source.x + ei.target.x) / 2,\n      y: (ei.source.y + ei.target.y) / 2\n    };\n    var jMid = {\n      x: (ej.source.x + ej.target.x) / 2,\n      y: (ej.source.y + ej.target.y) / 2\n    };\n    var distance = getEucliDis(iMid, jMid);\n    return aLength / (aLength + distance);\n  };\n\n  Bundling.prototype.getVisibilityScore = function (ei, ej) {\n    var vij = this.getEdgeVisibility(ei, ej);\n    var vji = this.getEdgeVisibility(ej, ei);\n    return vij < vji ? vij : vji;\n  };\n\n  Bundling.prototype.getEdgeVisibility = function (ei, ej) {\n    var ps = projectPointToEdge(ej.source, ei);\n    var pt = projectPointToEdge(ej.target, ei);\n    var pMid = {\n      x: (ps.x + pt.x) / 2,\n      y: (ps.y + pt.y) / 2\n    };\n    var iMid = {\n      x: (ei.source.x + ei.target.x) / 2,\n      y: (ei.source.y + ei.target.y) / 2\n    };\n    return Math.max(0, 1 - 2 * getEucliDis(pMid, iMid) / getEucliDis(ps, pt));\n  };\n\n  Bundling.prototype.getEdgeForces = function (e, eidx, divisions, lambda) {\n    var self = this;\n    var edgePoints = self.get('edgePoints');\n    var K = self.get('K');\n    var kp = K / (getEucliDis(e.source, e.target) * (divisions + 1));\n    var edgePointForces = [{\n      x: 0,\n      y: 0\n    }];\n\n    for (var i = 1; i < divisions; i++) {\n      var force = {\n        x: 0,\n        y: 0\n      };\n      var spring = self.getSpringForce({\n        pre: edgePoints[eidx][i - 1],\n        cur: edgePoints[eidx][i],\n        next: edgePoints[eidx][i + 1]\n      }, kp);\n      var electrostatic = self.getElectrostaticForce(i, eidx);\n      force.x = lambda * (spring.x + electrostatic.x);\n      force.y = lambda * (spring.y + electrostatic.y);\n      edgePointForces.push(force);\n    }\n\n    edgePointForces.push({\n      x: 0,\n      y: 0\n    });\n    return edgePointForces;\n  };\n\n  Bundling.prototype.getSpringForce = function (divisions, kp) {\n    var x = divisions.pre.x + divisions.next.x - 2 * divisions.cur.x;\n    var y = divisions.pre.y + divisions.next.y - 2 * divisions.cur.y;\n    x *= kp;\n    y *= kp;\n    return {\n      x: x,\n      y: y\n    };\n  };\n\n  Bundling.prototype.getElectrostaticForce = function (pidx, eidx) {\n    var self = this;\n    var eps = self.get('eps');\n    var edgeBundles = self.get('edgeBundles');\n    var edgePoints = self.get('edgePoints');\n    var edgeBundle = edgeBundles[eidx];\n    var resForce = {\n      x: 0,\n      y: 0\n    };\n    edgeBundle.forEach(function (eb) {\n      var force = {\n        x: edgePoints[eb][pidx].x - edgePoints[eidx][pidx].x,\n        y: edgePoints[eb][pidx].y - edgePoints[eidx][pidx].y\n      };\n\n      if (Math.abs(force.x) > eps || Math.abs(force.y) > eps) {\n        var length_1 = getEucliDis(edgePoints[eb][pidx], edgePoints[eidx][pidx]);\n        var diff = 1 / length_1;\n        resForce.x += force.x * diff;\n        resForce.y += force.y * diff;\n      }\n    });\n    return resForce;\n  };\n\n  Bundling.prototype.isTicking = function () {\n    return this.get('ticking');\n  };\n\n  Bundling.prototype.getSimulation = function () {\n    return this.get('forceSimulation');\n  };\n\n  Bundling.prototype.destroy = function () {\n    if (this.get('ticking')) {\n      this.getSimulation().stop();\n    }\n\n    _super.prototype.destroy.call(this);\n  };\n\n  return Bundling;\n}(Base);\n\nexport default Bundling;","map":{"version":3,"sources":["/home/manolo/sds-ui/node_modules/@antv/g6-plugin/es/bundling/index.js"],"names":["__extends","_extendStatics","extendStatics","d","b","Object","setPrototypeOf","__proto__","Array","p","prototype","hasOwnProperty","call","TypeError","String","__","constructor","create","Base","getEucliDis","pointA","pointB","eps","vx","x","vy","y","Math","abs","sqrt","getDotProduct","ei","ej","projectPointToEdge","e","k","source","target","Bundling","_super","config","getDefaultCfgs","edgeBundles","edgePoints","K","lambda","divisions","divRate","cycles","iterations","iterRate","bundleThreshold","onLayoutEnd","onTick","init","graph","get","tick","refreshPositions","set","bundling","data","self","isTicking","edges","nodes","nodeIdMap","error","forEach","node","undefined","id","Error","divideEdges","getEdgeBundles","C","i","_loop_1","j","forces","getEdgeForces","type","controlPoints","slice","length","refresh","updateBundling","cfg","keys","key","graph_1","edge","push","edgeLength","getEdgeLength","divisionLength_1","currentDivisonLength_1","newEdgePoints_1","ep","oriDivisionLength","ratio","edgePoint","points","iSource","iTarget","jSource","jTarget","score","getBundleScore","aScore","getAngleScore","sScore","getScaleScore","pScore","getPositionScore","vScore","getVisibilityScore","dotProduct","aLength","min","max","iMid","jMid","distance","vij","getEdgeVisibility","vji","ps","pt","pMid","eidx","kp","edgePointForces","force","spring","getSpringForce","pre","cur","next","electrostatic","getElectrostaticForce","pidx","edgeBundle","resForce","eb","length_1","diff","getSimulation","destroy","stop"],"mappings":"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","sourcesContent":["var __extends = this && this.__extends || function () {\n  var _extendStatics = function extendStatics(d, b) {\n    _extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) {\n        if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p];\n      }\n    };\n\n    return _extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    if (typeof b !== \"function\" && b !== null) throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n\n    _extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nimport Base from '../base';\n\nfunction getEucliDis(pointA, pointB, eps) {\n  var vx = pointA.x - pointB.x;\n  var vy = pointA.y - pointB.y;\n\n  if (!eps || Math.abs(vx) > eps || Math.abs(vy) > eps) {\n    return Math.sqrt(vx * vx + vy * vy);\n  }\n\n  return eps;\n}\n\nfunction getDotProduct(ei, ej) {\n  return ei.x * ej.x + ei.y * ej.y;\n}\n\nfunction projectPointToEdge(p, e) {\n  var k = (e.source.y - e.target.y) / (e.source.x - e.target.x);\n  var x = (k * k * e.source.x + k * (p.y - e.source.y) + p.x) / (k * k + 1);\n  var y = k * (x - e.source.x) + e.source.y;\n  return {\n    x: x,\n    y: y\n  };\n}\n\nvar Bundling =\n/** @class */\nfunction (_super) {\n  __extends(Bundling, _super);\n\n  function Bundling(config) {\n    return _super.call(this, config) || this;\n  }\n\n  Bundling.prototype.getDefaultCfgs = function () {\n    return {\n      edgeBundles: [],\n      edgePoints: [],\n      K: 0.1,\n      lambda: 0.1,\n      divisions: 1,\n      divRate: 2,\n      cycles: 6,\n      iterations: 90,\n      iterRate: 0.6666667,\n      bundleThreshold: 0.6,\n      eps: 1e-6,\n      onLayoutEnd: function onLayoutEnd() {},\n      onTick: function onTick() {}\n    };\n  };\n\n  Bundling.prototype.init = function () {\n    var graph = this.get('graph');\n    var onTick = this.get('onTick');\n\n    var tick = function tick() {\n      if (onTick) {\n        onTick();\n      }\n\n      graph.refreshPositions();\n    };\n\n    this.set('tick', tick);\n  };\n\n  Bundling.prototype.bundling = function (data) {\n    var self = this;\n    self.set('data', data); // 如果正在布局，忽略布局请求\n\n    if (self.isTicking()) {\n      return;\n    }\n\n    var edges = data.edges || [];\n    var nodes = data.nodes || [];\n    var nodeIdMap = {};\n    var error = false;\n    nodes.forEach(function (node) {\n      if (node.x === null || !node.y === null || node.x === undefined || !node.y === undefined) {\n        error = true;\n      }\n\n      nodeIdMap[node.id] = node;\n    });\n    if (error) throw new Error('please layout the graph or assign x and y for nodes first');\n    self.set('nodeIdMap', nodeIdMap); // subdivide each edges\n\n    var divisions = self.get('divisions');\n    var divRate = self.get('divRate');\n    var edgePoints = self.divideEdges(divisions);\n    self.set('edgePoints', edgePoints); // compute the bundles\n\n    var edgeBundles = self.getEdgeBundles();\n    self.set('edgeBundles', edgeBundles); // iterations\n\n    var C = self.get('cycles');\n    var iterations = self.get('iterations');\n    var iterRate = self.get('iterRate');\n    var lambda = self.get('lambda');\n\n    for (var i = 0; i < C; i++) {\n      var _loop_1 = function _loop_1(j) {\n        var forces = [];\n        edges.forEach(function (e, k) {\n          if (e.source === e.target) return;\n          var source = nodeIdMap[e.source];\n          var target = nodeIdMap[e.target];\n          forces[k] = self.getEdgeForces({\n            source: source,\n            target: target\n          }, k, divisions, lambda);\n\n          for (var p = 0; p < divisions + 1; p++) {\n            edgePoints[k][p].x += forces[k][p].x;\n            edgePoints[k][p].y += forces[k][p].y;\n          }\n        });\n      };\n\n      for (var j = 0; j < iterations; j++) {\n        _loop_1(j);\n      } // parameters for nex cycle\n\n\n      lambda = lambda / 2;\n      divisions *= divRate;\n      iterations *= iterRate;\n      edgePoints = self.divideEdges(divisions);\n      self.set('edgePoints', edgePoints);\n    } // change the edges according to edgePoints\n\n\n    edges.forEach(function (e, i) {\n      if (e.source === e.target) return;\n      e.type = 'polyline';\n      e.controlPoints = edgePoints[i].slice(1, edgePoints[i].length - 1);\n    });\n    var graph = self.get('graph');\n    graph.refresh();\n  };\n\n  Bundling.prototype.updateBundling = function (cfg) {\n    var self = this;\n    var data = cfg.data;\n\n    if (data) {\n      self.set('data', data);\n    }\n\n    if (self.get('ticking')) {\n      self.set('ticking', false);\n    }\n\n    Object.keys(cfg).forEach(function (key) {\n      self.set(key, cfg[key]);\n    });\n\n    if (cfg.onTick) {\n      var graph_1 = this.get('graph');\n      self.set('tick', function () {\n        cfg.onTick();\n        graph_1.refresh();\n      });\n    }\n\n    self.bundling(data);\n  };\n\n  Bundling.prototype.divideEdges = function (divisions) {\n    var self = this;\n    var edges = self.get('data').edges;\n    var nodeIdMap = self.get('nodeIdMap');\n    var edgePoints = self.get('edgePoints');\n    if (!edgePoints || edgePoints === undefined) edgePoints = [];\n    edges.forEach(function (edge, i) {\n      if (!edgePoints[i] || edgePoints[i] === undefined) {\n        edgePoints[i] = [];\n      }\n\n      var source = nodeIdMap[edge.source];\n      var target = nodeIdMap[edge.target];\n\n      if (divisions === 1) {\n        edgePoints[i].push({\n          x: source.x,\n          y: source.y\n        }); // source\n\n        edgePoints[i].push({\n          x: 0.5 * (source.x + target.x),\n          y: 0.5 * (source.y + target.y)\n        }); // mid\n\n        edgePoints[i].push({\n          x: target.x,\n          y: target.y\n        }); // target\n      } else {\n        var edgeLength = 0;\n\n        if (!edgePoints[i] || edgePoints[i] === []) {\n          // it is a straight line\n          edgeLength = getEucliDis({\n            x: source.x,\n            y: source.y\n          }, {\n            x: target.x,\n            y: target.y\n          });\n        } else {\n          edgeLength = self.getEdgeLength(edgePoints[i]);\n        }\n\n        var divisionLength_1 = edgeLength / (divisions + 1);\n        var currentDivisonLength_1 = divisionLength_1;\n        var newEdgePoints_1 = [{\n          x: source.x,\n          y: source.y\n        }]; // source\n\n        edgePoints[i].forEach(function (ep, j) {\n          if (j === 0) return;\n          var oriDivisionLength = getEucliDis(ep, edgePoints[i][j - 1]);\n\n          while (oriDivisionLength > currentDivisonLength_1) {\n            var ratio = currentDivisonLength_1 / oriDivisionLength;\n            var edgePoint = {\n              x: edgePoints[i][j - 1].x,\n              y: edgePoints[i][j - 1].y\n            };\n            edgePoint.x += ratio * (ep.x - edgePoints[i][j - 1].x);\n            edgePoint.y += ratio * (ep.y - edgePoints[i][j - 1].y);\n            newEdgePoints_1.push(edgePoint);\n            oriDivisionLength -= currentDivisonLength_1;\n            currentDivisonLength_1 = divisionLength_1;\n          }\n\n          currentDivisonLength_1 -= oriDivisionLength;\n        });\n        newEdgePoints_1.push({\n          x: target.x,\n          y: target.y\n        }); // target\n\n        edgePoints[i] = newEdgePoints_1;\n      }\n    });\n    return edgePoints;\n  };\n  /**\n   * 计算边的长度\n   * @param points\n   */\n\n\n  Bundling.prototype.getEdgeLength = function (points) {\n    var length = 0;\n    points.forEach(function (p, i) {\n      if (i === 0) return;\n      length += getEucliDis(p, points[i - 1]);\n    });\n    return length;\n  };\n\n  Bundling.prototype.getEdgeBundles = function () {\n    var self = this;\n    var data = self.get('data');\n    var edges = data.edges || [];\n    var bundleThreshold = self.get('bundleThreshold');\n    var nodeIdMap = self.get('nodeIdMap');\n    var edgeBundles = self.get('edgeBundles');\n    if (!edgeBundles) edgeBundles = [];\n    edges.forEach(function (e, i) {\n      if (!edgeBundles[i] || edgeBundles[i] === undefined) {\n        edgeBundles[i] = [];\n      }\n    });\n    edges.forEach(function (ei, i) {\n      var iSource = nodeIdMap[ei.source];\n      var iTarget = nodeIdMap[ei.target];\n      edges.forEach(function (ej, j) {\n        if (j <= i) return;\n        var jSource = nodeIdMap[ej.source];\n        var jTarget = nodeIdMap[ej.target];\n        var score = self.getBundleScore({\n          source: iSource,\n          target: iTarget\n        }, {\n          source: jSource,\n          target: jTarget\n        });\n\n        if (score >= bundleThreshold) {\n          edgeBundles[i].push(j);\n          edgeBundles[j].push(i);\n        }\n      });\n    });\n    return edgeBundles;\n  };\n\n  Bundling.prototype.getBundleScore = function (ei, ej) {\n    var self = this;\n    ei.vx = ei.target.x - ei.source.x;\n    ei.vy = ei.target.y - ei.source.y;\n    ej.vx = ej.target.x - ej.source.x;\n    ej.vy = ej.target.y - ej.source.y;\n    ei.length = getEucliDis({\n      x: ei.source.x,\n      y: ei.source.y\n    }, {\n      x: ei.target.x,\n      y: ei.target.y\n    });\n    ej.length = getEucliDis({\n      x: ej.source.x,\n      y: ej.source.y\n    }, {\n      x: ej.target.x,\n      y: ej.target.y\n    }); // angle score\n\n    var aScore = self.getAngleScore(ei, ej); // scale score\n\n    var sScore = self.getScaleScore(ei, ej); // position score\n\n    var pScore = self.getPositionScore(ei, ej); // visibility socre\n\n    var vScore = self.getVisibilityScore(ei, ej);\n    return aScore * sScore * pScore * vScore;\n  };\n\n  Bundling.prototype.getAngleScore = function (ei, ej) {\n    var dotProduct = getDotProduct({\n      x: ei.vx,\n      y: ei.vy\n    }, {\n      x: ej.vx,\n      y: ej.vy\n    });\n    return dotProduct / (ei.length * ej.length);\n  };\n\n  Bundling.prototype.getScaleScore = function (ei, ej) {\n    var aLength = (ei.length + ej.length) / 2;\n    var score = 2 / (aLength / Math.min(ei.length, ej.length) + Math.max(ei.length, ej.length) / aLength);\n    return score;\n  };\n\n  Bundling.prototype.getPositionScore = function (ei, ej) {\n    var aLength = (ei.length + ej.length) / 2;\n    var iMid = {\n      x: (ei.source.x + ei.target.x) / 2,\n      y: (ei.source.y + ei.target.y) / 2\n    };\n    var jMid = {\n      x: (ej.source.x + ej.target.x) / 2,\n      y: (ej.source.y + ej.target.y) / 2\n    };\n    var distance = getEucliDis(iMid, jMid);\n    return aLength / (aLength + distance);\n  };\n\n  Bundling.prototype.getVisibilityScore = function (ei, ej) {\n    var vij = this.getEdgeVisibility(ei, ej);\n    var vji = this.getEdgeVisibility(ej, ei);\n    return vij < vji ? vij : vji;\n  };\n\n  Bundling.prototype.getEdgeVisibility = function (ei, ej) {\n    var ps = projectPointToEdge(ej.source, ei);\n    var pt = projectPointToEdge(ej.target, ei);\n    var pMid = {\n      x: (ps.x + pt.x) / 2,\n      y: (ps.y + pt.y) / 2\n    };\n    var iMid = {\n      x: (ei.source.x + ei.target.x) / 2,\n      y: (ei.source.y + ei.target.y) / 2\n    };\n    return Math.max(0, 1 - 2 * getEucliDis(pMid, iMid) / getEucliDis(ps, pt));\n  };\n\n  Bundling.prototype.getEdgeForces = function (e, eidx, divisions, lambda) {\n    var self = this;\n    var edgePoints = self.get('edgePoints');\n    var K = self.get('K');\n    var kp = K / (getEucliDis(e.source, e.target) * (divisions + 1));\n    var edgePointForces = [{\n      x: 0,\n      y: 0\n    }];\n\n    for (var i = 1; i < divisions; i++) {\n      var force = {\n        x: 0,\n        y: 0\n      };\n      var spring = self.getSpringForce({\n        pre: edgePoints[eidx][i - 1],\n        cur: edgePoints[eidx][i],\n        next: edgePoints[eidx][i + 1]\n      }, kp);\n      var electrostatic = self.getElectrostaticForce(i, eidx);\n      force.x = lambda * (spring.x + electrostatic.x);\n      force.y = lambda * (spring.y + electrostatic.y);\n      edgePointForces.push(force);\n    }\n\n    edgePointForces.push({\n      x: 0,\n      y: 0\n    });\n    return edgePointForces;\n  };\n\n  Bundling.prototype.getSpringForce = function (divisions, kp) {\n    var x = divisions.pre.x + divisions.next.x - 2 * divisions.cur.x;\n    var y = divisions.pre.y + divisions.next.y - 2 * divisions.cur.y;\n    x *= kp;\n    y *= kp;\n    return {\n      x: x,\n      y: y\n    };\n  };\n\n  Bundling.prototype.getElectrostaticForce = function (pidx, eidx) {\n    var self = this;\n    var eps = self.get('eps');\n    var edgeBundles = self.get('edgeBundles');\n    var edgePoints = self.get('edgePoints');\n    var edgeBundle = edgeBundles[eidx];\n    var resForce = {\n      x: 0,\n      y: 0\n    };\n    edgeBundle.forEach(function (eb) {\n      var force = {\n        x: edgePoints[eb][pidx].x - edgePoints[eidx][pidx].x,\n        y: edgePoints[eb][pidx].y - edgePoints[eidx][pidx].y\n      };\n\n      if (Math.abs(force.x) > eps || Math.abs(force.y) > eps) {\n        var length_1 = getEucliDis(edgePoints[eb][pidx], edgePoints[eidx][pidx]);\n        var diff = 1 / length_1;\n        resForce.x += force.x * diff;\n        resForce.y += force.y * diff;\n      }\n    });\n    return resForce;\n  };\n\n  Bundling.prototype.isTicking = function () {\n    return this.get('ticking');\n  };\n\n  Bundling.prototype.getSimulation = function () {\n    return this.get('forceSimulation');\n  };\n\n  Bundling.prototype.destroy = function () {\n    if (this.get('ticking')) {\n      this.getSimulation().stop();\n    }\n\n    _super.prototype.destroy.call(this);\n  };\n\n  return Bundling;\n}(Base);\n\nexport default Bundling;"]},"metadata":{},"sourceType":"module"}