{"ast":null,"code":"import _asyncToGenerator from \"@babel/runtime/helpers/asyncToGenerator\";\nimport _initializerDefineProperty from \"@babel/runtime/helpers/initializerDefineProperty\";\nimport _classCallCheck from \"@babel/runtime/helpers/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/createClass\";\nimport _assertThisInitialized from \"@babel/runtime/helpers/assertThisInitialized\";\nimport _inherits from \"@babel/runtime/helpers/inherits\";\nimport _possibleConstructorReturn from \"@babel/runtime/helpers/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime/helpers/getPrototypeOf\";\nimport _defineProperty from \"@babel/runtime/helpers/defineProperty\";\nimport _applyDecoratedDescriptor from \"@babel/runtime/helpers/applyDecoratedDescriptor\";\nimport _initializerWarningHelper from \"@babel/runtime/helpers/initializerWarningHelper\";\n\nvar _dec, _dec2, _dec3, _dec4, _dec5, _dec6, _dec7, _dec8, _dec9, _dec10, _dec11, _dec12, _dec13, _dec14, _dec15, _dec16, _class, _class2, _descriptor, _descriptor2, _descriptor3, _descriptor4, _descriptor5, _descriptor6, _descriptor7, _descriptor8, _descriptor9, _descriptor10, _descriptor11, _descriptor12, _descriptor13, _descriptor14, _descriptor15;\n\nimport _regeneratorRuntime from \"@babel/runtime/regenerator\";\n\nfunction _createSuper(Derived) {\n  var hasNativeReflectConstruct = _isNativeReflectConstruct();\n\n  return function _createSuperInternal() {\n    var Super = _getPrototypeOf(Derived),\n        result;\n\n    if (hasNativeReflectConstruct) {\n      var NewTarget = _getPrototypeOf(this).constructor;\n\n      result = Reflect.construct(Super, arguments, NewTarget);\n    } else {\n      result = Super.apply(this, arguments);\n    }\n\n    return _possibleConstructorReturn(this, result);\n  };\n}\n\nfunction _isNativeReflectConstruct() {\n  if (typeof Reflect === \"undefined\" || !Reflect.construct) return false;\n  if (Reflect.construct.sham) return false;\n  if (typeof Proxy === \"function\") return true;\n\n  try {\n    Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {}));\n    return true;\n  } catch (e) {\n    return false;\n  }\n}\n\nimport { AsyncParallelHook } from '@antv/async-hook';\nimport { $window, DOM } from '@antv/l7-utils';\nimport elementResizeEvent, { unbind } from 'element-resize-event';\nimport { EventEmitter } from 'eventemitter3';\nimport { inject, injectable } from 'inversify';\nimport 'reflect-metadata';\nimport { TYPES } from '../../types';\nimport { createRendererContainer } from '../../utils/dom';\nimport { InteractionEvent } from '../interaction/IInteractionService';\nvar Scene = (_dec = injectable(), _dec2 = inject(TYPES.SceneID), _dec3 = inject(TYPES.IIconService), _dec4 = inject(TYPES.IFontService), _dec5 = inject(TYPES.IControlService), _dec6 = inject(TYPES.IGlobalConfigService), _dec7 = inject(TYPES.IMapService), _dec8 = inject(TYPES.ICoordinateSystemService), _dec9 = inject(TYPES.IRendererService), _dec10 = inject(TYPES.ILayerService), _dec11 = inject(TYPES.ICameraService), _dec12 = inject(TYPES.IInteractionService), _dec13 = inject(TYPES.IPickingService), _dec14 = inject(TYPES.IShaderModuleService), _dec15 = inject(TYPES.IMarkerService), _dec16 = inject(TYPES.IPopupService), _dec(_class = (_class2 = function (_EventEmitter) {\n  _inherits(Scene, _EventEmitter);\n\n  var _super = _createSuper(Scene);\n\n  function Scene() {\n    var _this;\n\n    _classCallCheck(this, Scene);\n\n    _this = _super.call(this);\n\n    _defineProperty(_assertThisInitialized(_this), \"destroyed\", false);\n\n    _defineProperty(_assertThisInitialized(_this), \"loaded\", false);\n\n    _defineProperty(_assertThisInitialized(_this), \"loadFont\", false);\n\n    _defineProperty(_assertThisInitialized(_this), \"fontFamily\", '');\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"id\", _descriptor, _assertThisInitialized(_this));\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"iconService\", _descriptor2, _assertThisInitialized(_this));\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"fontService\", _descriptor3, _assertThisInitialized(_this));\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"controlService\", _descriptor4, _assertThisInitialized(_this));\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"configService\", _descriptor5, _assertThisInitialized(_this));\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"map\", _descriptor6, _assertThisInitialized(_this));\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"coordinateSystemService\", _descriptor7, _assertThisInitialized(_this));\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"rendererService\", _descriptor8, _assertThisInitialized(_this));\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"layerService\", _descriptor9, _assertThisInitialized(_this));\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"cameraService\", _descriptor10, _assertThisInitialized(_this));\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"interactionService\", _descriptor11, _assertThisInitialized(_this));\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"pickingService\", _descriptor12, _assertThisInitialized(_this));\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"shaderModuleService\", _descriptor13, _assertThisInitialized(_this));\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"markerService\", _descriptor14, _assertThisInitialized(_this));\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"popupService\", _descriptor15, _assertThisInitialized(_this));\n\n    _defineProperty(_assertThisInitialized(_this), \"inited\", false);\n\n    _defineProperty(_assertThisInitialized(_this), \"initPromise\", void 0);\n\n    _defineProperty(_assertThisInitialized(_this), \"rendering\", false);\n\n    _defineProperty(_assertThisInitialized(_this), \"$container\", void 0);\n\n    _defineProperty(_assertThisInitialized(_this), \"canvas\", void 0);\n\n    _defineProperty(_assertThisInitialized(_this), \"markerContainer\", void 0);\n\n    _defineProperty(_assertThisInitialized(_this), \"hooks\", void 0);\n\n    _defineProperty(_assertThisInitialized(_this), \"handleWindowResized\", function () {\n      _this.emit('resize');\n\n      if (_this.$container) {\n        _this.initContainer();\n\n        DOM.triggerResize();\n        _this.coordinateSystemService.needRefresh = true;\n\n        _this.render();\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"handleMapCameraChanged\", function (viewport) {\n      _this.cameraService.update(viewport);\n\n      _this.render();\n    });\n\n    _this.hooks = {\n      init: new AsyncParallelHook()\n    };\n    return _this;\n  }\n\n  _createClass(Scene, [{\n    key: \"init\",\n    value: function init(sceneConfig) {\n      var _this2 = this;\n\n      this.configService.setSceneConfig(this.id, sceneConfig);\n      this.shaderModuleService.registerBuiltinModules();\n      this.iconService.init();\n      this.fontService.init();\n      this.hooks.init.tapPromise('initMap', _asyncToGenerator(_regeneratorRuntime.mark(function _callee() {\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.next = 2;\n                return new Promise(function (resolve) {\n                  _this2.map.onCameraChanged(function (viewport) {\n                    _this2.cameraService.init();\n\n                    _this2.cameraService.update(viewport);\n\n                    if (_this2.map.version !== 'GAODE2.x') {\n                      resolve();\n                    }\n                  });\n\n                  if (_this2.map.version !== 'GAODE2.x') {\n                    _this2.map.init();\n                  } else {\n                    resolve();\n                  }\n                });\n\n              case 2:\n                if (!(_this2.map.version === 'GAODE2.x' && _this2.map.initViewPort)) {\n                  _context.next = 6;\n                  break;\n                }\n\n                _context.next = 5;\n                return _this2.map.init();\n\n              case 5:\n                _this2.map.initViewPort();\n\n              case 6:\n                _this2.map.onCameraChanged(_this2.handleMapCameraChanged);\n\n                _this2.map.addMarkerContainer();\n\n                _this2.markerService.addMarkers();\n\n                _this2.markerService.addMarkerLayers();\n\n                _this2.popupService.initPopup();\n\n                _this2.interactionService.init();\n\n                _this2.interactionService.on(InteractionEvent.Drag, _this2.addSceneEvent.bind(_this2));\n\n              case 13:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee);\n      })));\n      this.hooks.init.tapPromise('initRenderer', _asyncToGenerator(_regeneratorRuntime.mark(function _callee2() {\n        var $container, _$window$matchMedia;\n\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                $container = createRendererContainer(_this2.configService.getSceneConfig(_this2.id).id || '');\n                _this2.$container = $container;\n\n                if (!$container) {\n                  _context2.next = 11;\n                  break;\n                }\n\n                _this2.canvas = DOM.create('canvas', '', $container);\n\n                _this2.setCanvas();\n\n                _context2.next = 7;\n                return _this2.rendererService.init(_this2.canvas, _this2.configService.getSceneConfig(_this2.id));\n\n              case 7:\n                elementResizeEvent(_this2.$container, _this2.handleWindowResized);\n\n                if ($window.matchMedia) {\n                  (_$window$matchMedia = $window.matchMedia('screen and (-webkit-min-device-pixel-ratio: 1.5)')) === null || _$window$matchMedia === void 0 ? void 0 : _$window$matchMedia.addListener(_this2.handleWindowResized);\n                }\n\n                _context2.next = 12;\n                break;\n\n              case 11:\n                console.error('容器 id 不存在');\n\n              case 12:\n                _this2.pickingService.init(_this2.id);\n\n              case 13:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2);\n      })));\n      this.initPromise = this.hooks.init.promise();\n      this.render();\n    }\n  }, {\n    key: \"initMiniScene\",\n    value: function initMiniScene(sceneConfig) {\n      var _this3 = this;\n\n      this.configService.setSceneConfig(this.id, sceneConfig);\n      this.shaderModuleService.registerBuiltinModules();\n      this.iconService.init();\n      this.fontService.init();\n      this.hooks.init.tapPromise('initMap', _asyncToGenerator(_regeneratorRuntime.mark(function _callee3() {\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                _context3.next = 2;\n                return new Promise(function (resolve) {\n                  _this3.map.onCameraChanged(function (viewport) {\n                    _this3.cameraService.init();\n\n                    _this3.cameraService.update(viewport);\n\n                    if (_this3.map.version !== 'GAODE2.x') {\n                      resolve();\n                    }\n                  });\n\n                  _this3.map.initMiniMap();\n                });\n\n              case 2:\n                _this3.map.onCameraChanged(_this3.handleMapCameraChanged);\n\n                _this3.interactionService.init();\n\n                _this3.interactionService.on(InteractionEvent.Drag, _this3.addSceneEvent.bind(_this3));\n\n              case 5:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3);\n      })));\n      this.hooks.init.tapPromise('initRenderer', _asyncToGenerator(_regeneratorRuntime.mark(function _callee4() {\n        var $container;\n        return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                $container = sceneConfig.canvas;\n                _this3.$container = $container ? $container : null;\n\n                if (!_this3.$container) {\n                  _context4.next = 7;\n                  break;\n                }\n\n                _context4.next = 5;\n                return _this3.rendererService.init(sceneConfig.canvas, _this3.configService.getSceneConfig(_this3.id));\n\n              case 5:\n                _context4.next = 8;\n                break;\n\n              case 7:\n                console.error('容器 id 不存在');\n\n              case 8:\n                _this3.pickingService.init(_this3.id);\n\n              case 9:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4);\n      })));\n      this.initPromise = this.hooks.init.promise();\n      this.render();\n    }\n  }, {\n    key: \"addLayer\",\n    value: function addLayer(layer) {\n      this.layerService.sceneService = this;\n      this.layerService.add(layer);\n      this.render();\n    }\n  }, {\n    key: \"render\",\n    value: function () {\n      var _render = _asyncToGenerator(_regeneratorRuntime.mark(function _callee5() {\n        return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                if (!(this.rendering || this.destroyed)) {\n                  _context5.next = 2;\n                  break;\n                }\n\n                return _context5.abrupt(\"return\");\n\n              case 2:\n                this.rendering = true;\n\n                if (this.inited) {\n                  _context5.next = 15;\n                  break;\n                }\n\n                _context5.next = 6;\n                return this.initPromise;\n\n              case 6:\n                if (this.destroyed) {\n                  this.destroy();\n                }\n\n                if (!(this.loadFont && document.fonts)) {\n                  _context5.next = 10;\n                  break;\n                }\n\n                _context5.next = 10;\n                return document.fonts.load(\"24px \".concat(this.fontFamily), 'L7text');\n\n              case 10:\n                this.layerService.initLayers();\n                this.controlService.addControls();\n                this.loaded = true;\n                this.emit('loaded');\n                this.inited = true;\n\n              case 15:\n                this.layerService.updateLayerRenderList();\n                this.layerService.renderLayers();\n                this.rendering = false;\n\n              case 18:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5, this);\n      }));\n\n      function render() {\n        return _render.apply(this, arguments);\n      }\n\n      return render;\n    }()\n  }, {\n    key: \"addFontFace\",\n    value: function addFontFace(fontFamily, fontPath) {\n      this.fontFamily = fontFamily;\n      var style = document.createElement('style');\n      style.type = 'text/css';\n      style.innerText = \"\\n        @font-face{\\n            font-family: '\".concat(fontFamily, \"';\\n            src: url('\").concat(fontPath, \"') format('woff2'),\\n            url('\").concat(fontPath, \"') format('woff'),\\n            url('\").concat(fontPath, \"') format('truetype');\\n        }\");\n      document.getElementsByTagName('head')[0].appendChild(style);\n      this.loadFont = true;\n    }\n  }, {\n    key: \"getSceneContainer\",\n    value: function getSceneContainer() {\n      return this.$container;\n    }\n  }, {\n    key: \"exportPng\",\n    value: function exportPng(type) {\n      var _this$$container;\n\n      var renderCanvas = (_this$$container = this.$container) === null || _this$$container === void 0 ? void 0 : _this$$container.getElementsByTagName('canvas')[0];\n      this.render();\n      var layersPng = type === 'jpg' ? renderCanvas === null || renderCanvas === void 0 ? void 0 : renderCanvas.toDataURL('image/jpeg') : renderCanvas === null || renderCanvas === void 0 ? void 0 : renderCanvas.toDataURL('image/png');\n      return layersPng;\n    }\n  }, {\n    key: \"getSceneConfig\",\n    value: function getSceneConfig() {\n      return this.configService.getSceneConfig(this.id);\n    }\n  }, {\n    key: \"addMarkerContainer\",\n    value: function addMarkerContainer() {\n      var mapContainer = this.$container.parentElement;\n\n      if (mapContainer !== null) {\n        this.markerContainer = DOM.create('div', 'l7-marker-container', mapContainer);\n      }\n    }\n  }, {\n    key: \"getMarkerContainer\",\n    value: function getMarkerContainer() {\n      return this.markerContainer;\n    }\n  }, {\n    key: \"destroy\",\n    value: function destroy() {\n      var _this$$container2, _this$$container2$par;\n\n      if (!this.inited) {\n        this.destroyed = true;\n        return;\n      }\n\n      this.emit('destroy');\n      this.layerService.destroy();\n      this.rendererService.destroy();\n      this.map.destroy();\n      this.interactionService.destroy();\n      this.controlService.destroy();\n      this.markerService.destroy();\n      (_this$$container2 = this.$container) === null || _this$$container2 === void 0 ? void 0 : (_this$$container2$par = _this$$container2.parentNode) === null || _this$$container2$par === void 0 ? void 0 : _this$$container2$par.removeChild(this.$container);\n      this.removeAllListeners();\n      this.inited = false;\n      unbind(this.$container, this.handleWindowResized);\n\n      if ($window.matchMedia) {\n        var _$window$matchMedia2;\n\n        (_$window$matchMedia2 = $window.matchMedia('screen and (min-resolution: 2dppx)')) === null || _$window$matchMedia2 === void 0 ? void 0 : _$window$matchMedia2.removeListener(this.handleWindowResized);\n      }\n    }\n  }, {\n    key: \"initContainer\",\n    value: function initContainer() {\n      var _this$$container3, _this$$container4;\n\n      var pixelRatio = DOM.DPR;\n      var w = ((_this$$container3 = this.$container) === null || _this$$container3 === void 0 ? void 0 : _this$$container3.clientWidth) || 400;\n      var h = ((_this$$container4 = this.$container) === null || _this$$container4 === void 0 ? void 0 : _this$$container4.clientHeight) || 300;\n      var canvas = this.canvas;\n\n      if (canvas) {\n        canvas.width = w * pixelRatio;\n        canvas.height = h * pixelRatio;\n      }\n\n      this.rendererService.viewport({\n        x: 0,\n        y: 0,\n        width: pixelRatio * w,\n        height: pixelRatio * h\n      });\n    }\n  }, {\n    key: \"setCanvas\",\n    value: function setCanvas() {\n      var _this$$container5, _this$$container6;\n\n      var pixelRatio = DOM.DPR;\n      var w = ((_this$$container5 = this.$container) === null || _this$$container5 === void 0 ? void 0 : _this$$container5.clientWidth) || 400;\n      var h = ((_this$$container6 = this.$container) === null || _this$$container6 === void 0 ? void 0 : _this$$container6.clientHeight) || 300;\n      var canvas = this.canvas;\n      canvas.width = w * pixelRatio;\n      canvas.height = h * pixelRatio;\n      canvas.style.width = '100%';\n      canvas.style.height = '100%';\n    }\n  }, {\n    key: \"addSceneEvent\",\n    value: function addSceneEvent(target) {\n      this.emit(target.type, target);\n    }\n  }]);\n\n  return Scene;\n}(EventEmitter), (_descriptor = _applyDecoratedDescriptor(_class2.prototype, \"id\", [_dec2], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor2 = _applyDecoratedDescriptor(_class2.prototype, \"iconService\", [_dec3], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor3 = _applyDecoratedDescriptor(_class2.prototype, \"fontService\", [_dec4], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor4 = _applyDecoratedDescriptor(_class2.prototype, \"controlService\", [_dec5], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor5 = _applyDecoratedDescriptor(_class2.prototype, \"configService\", [_dec6], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor6 = _applyDecoratedDescriptor(_class2.prototype, \"map\", [_dec7], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor7 = _applyDecoratedDescriptor(_class2.prototype, \"coordinateSystemService\", [_dec8], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor8 = _applyDecoratedDescriptor(_class2.prototype, \"rendererService\", [_dec9], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor9 = _applyDecoratedDescriptor(_class2.prototype, \"layerService\", [_dec10], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor10 = _applyDecoratedDescriptor(_class2.prototype, \"cameraService\", [_dec11], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor11 = _applyDecoratedDescriptor(_class2.prototype, \"interactionService\", [_dec12], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor12 = _applyDecoratedDescriptor(_class2.prototype, \"pickingService\", [_dec13], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor13 = _applyDecoratedDescriptor(_class2.prototype, \"shaderModuleService\", [_dec14], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor14 = _applyDecoratedDescriptor(_class2.prototype, \"markerService\", [_dec15], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor15 = _applyDecoratedDescriptor(_class2.prototype, \"popupService\", [_dec16], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n})), _class2)) || _class);\nexport { Scene as default };","map":{"version":3,"sources":["../../../src/services/scene/SceneService.ts"],"names":["injectable","Scene","EventEmitter","inject","TYPES","init","resolve","InteractionEvent","$container","createRendererContainer","DOM","elementResizeEvent","$window","console","sceneConfig","document","style","renderCanvas","layersPng","type","mapContainer","unbind","pixelRatio","w","h","canvas","x","y","width","height","target"],"mappings":"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","sourcesContent":["// @ts-ignore\nimport { AsyncParallelHook } from '@antv/async-hook';\nimport { $window, DOM } from '@antv/l7-utils';\nimport elementResizeEvent, { unbind } from 'element-resize-event';\nimport { EventEmitter } from 'eventemitter3';\nimport { inject, injectable } from 'inversify';\nimport 'reflect-metadata';\nimport { TYPES } from '../../types';\nimport { createRendererContainer } from '../../utils/dom';\nimport { IFontService } from '../asset/IFontService';\nimport { IIconService } from '../asset/IIconService';\nimport { ICameraService, IViewport } from '../camera/ICameraService';\nimport { IControlService } from '../component/IControlService';\nimport { IMarkerService } from '../component/IMarkerService';\nimport { IPopupService } from '../component/IPopupService';\nimport { IGlobalConfigService, ISceneConfig } from '../config/IConfigService';\nimport { ICoordinateSystemService } from '../coordinate/ICoordinateSystemService';\nimport {\n  IInteractionService,\n  IInteractionTarget,\n  InteractionEvent,\n} from '../interaction/IInteractionService';\nimport { IPickingService } from '../interaction/IPickingService';\nimport { ILayer, ILayerService } from '../layer/ILayerService';\nimport { IMapCamera, IMapConfig, IMapService } from '../map/IMapService';\nimport { IRenderConfig, IRendererService } from '../renderer/IRendererService';\nimport { IShaderModuleService } from '../shader/IShaderModuleService';\nimport { ISceneService } from './ISceneService';\n\n/**\n * will emit `loaded` `resize` `destroy` event panstart panmove panend\n */\n@injectable()\nexport default class Scene extends EventEmitter implements ISceneService {\n  public destroyed: boolean = false;\n\n  public loaded: boolean = false;\n  // loadFont 判断用户当前是否添加自定义字体\n  public loadFont: boolean = false;\n  // fontFamily 用户当前自己添加的字体的名称\n  public fontFamily: string = '';\n\n  @inject(TYPES.SceneID)\n  private readonly id: string;\n  /**\n   * 使用各种 Service\n   */\n  @inject(TYPES.IIconService)\n  private readonly iconService: IIconService;\n\n  @inject(TYPES.IFontService)\n  private readonly fontService: IFontService;\n\n  @inject(TYPES.IControlService)\n  private readonly controlService: IControlService;\n\n  @inject(TYPES.IGlobalConfigService)\n  private readonly configService: IGlobalConfigService;\n\n  @inject(TYPES.IMapService)\n  private readonly map: IMapService;\n\n  @inject(TYPES.ICoordinateSystemService)\n  private readonly coordinateSystemService: ICoordinateSystemService;\n\n  @inject(TYPES.IRendererService)\n  private readonly rendererService: IRendererService;\n\n  @inject(TYPES.ILayerService)\n  private readonly layerService: ILayerService;\n\n  @inject(TYPES.ICameraService)\n  private readonly cameraService: ICameraService;\n\n  @inject(TYPES.IInteractionService)\n  private readonly interactionService: IInteractionService;\n\n  @inject(TYPES.IPickingService)\n  private readonly pickingService: IPickingService;\n\n  @inject(TYPES.IShaderModuleService)\n  private readonly shaderModuleService: IShaderModuleService;\n\n  @inject(TYPES.IMarkerService)\n  private readonly markerService: IMarkerService;\n\n  @inject(TYPES.IPopupService)\n  private readonly popupService: IPopupService;\n\n  /**\n   * 是否首次渲染\n   */\n  private inited: boolean = false;\n  private initPromise: Promise<void>;\n\n  // TODO: 改成状态机\n  private rendering: boolean = false;\n\n  /**\n   * canvas 容器\n   */\n  private $container: HTMLDivElement | null | HTMLCanvasElement;\n\n  private canvas: HTMLCanvasElement;\n\n  private markerContainer: HTMLElement;\n\n  private hooks: {\n    init: AsyncParallelHook;\n  };\n\n  public constructor() {\n    super();\n    // @see https://github.com/webpack/tapable#usage\n    this.hooks = {\n      /**\n       * 初始化异步任务，可并行：\n       * 1. initMap：初始化地图底图、相机\n       * 2. initRenderer：初始化渲染引擎\n       * 3. initWorker：初始化 Worker\n       */\n      init: new AsyncParallelHook(),\n    };\n  }\n\n  public init(sceneConfig: ISceneConfig) {\n    // 设置场景配置项\n    this.configService.setSceneConfig(this.id, sceneConfig);\n\n    // 初始化 ShaderModule\n    this.shaderModuleService.registerBuiltinModules();\n\n    // 初始化资源管理 图片\n    this.iconService.init();\n    // 字体资源\n    this.fontService.init();\n\n    /**\n     * 初始化底图\n     */\n    this.hooks.init.tapPromise('initMap', async () => {\n      // 等待首次相机同步\n      await new Promise<void>((resolve) => {\n        this.map.onCameraChanged((viewport: IViewport) => {\n          this.cameraService.init();\n          this.cameraService.update(viewport);\n          if (this.map.version !== 'GAODE2.x') {\n            // not amap2\n            resolve();\n          }\n        });\n\n        if (this.map.version !== 'GAODE2.x') {\n          // not amap2\n          this.map.init();\n        } else {\n          // amap2\n          resolve();\n        }\n      });\n\n      if (this.map.version === 'GAODE2.x' && this.map.initViewPort) {\n        // amap2\n        await this.map.init();\n        this.map.initViewPort();\n      }\n\n      // 重新绑定非首次相机更新事件\n      this.map.onCameraChanged(this.handleMapCameraChanged);\n      this.map.addMarkerContainer();\n\n      // 初始化未加载的marker;\n      this.markerService.addMarkers();\n      this.markerService.addMarkerLayers();\n      this.popupService.initPopup();\n      // 地图初始化之后 才能初始化 container 上的交互\n      this.interactionService.init();\n      this.interactionService.on(\n        InteractionEvent.Drag,\n        this.addSceneEvent.bind(this),\n      );\n    });\n\n    /**\n     * 初始化渲染引擎\n     */\n    this.hooks.init.tapPromise('initRenderer', async () => {\n      // 创建底图之上的 container\n      const $container = createRendererContainer(\n        this.configService.getSceneConfig(this.id).id || '',\n      );\n\n      // 添加marker container;\n      this.$container = $container;\n\n      if ($container) {\n        this.canvas = DOM.create('canvas', '', $container) as HTMLCanvasElement;\n        this.setCanvas();\n        await this.rendererService.init(\n          // @ts-ignore\n          this.canvas,\n          this.configService.getSceneConfig(this.id) as IRenderConfig,\n        );\n\n        elementResizeEvent(\n          this.$container as HTMLDivElement,\n          this.handleWindowResized,\n        );\n        if ($window.matchMedia) {\n          $window\n            .matchMedia('screen and (-webkit-min-device-pixel-ratio: 1.5)')\n            ?.addListener(this.handleWindowResized);\n        }\n      } else {\n        console.error('容器 id 不存在');\n      }\n      this.pickingService.init(this.id);\n    });\n    // TODO：init worker, fontAtlas...\n\n    // 执行异步并行初始化任务\n    // @ts-ignore\n    this.initPromise = this.hooks.init.promise();\n    this.render();\n  }\n\n  /**\n   * 小程序环境下初始化 Scene\n   * @param sceneConfig\n   */\n  public initMiniScene(sceneConfig: ISceneConfig) {\n    // 设置场景配置项\n    this.configService.setSceneConfig(this.id, sceneConfig);\n\n    // 初始化 ShaderModule\n    this.shaderModuleService.registerBuiltinModules();\n\n    // 初始化资源管理 图片\n    this.iconService.init();\n    // 字体资源\n    this.fontService.init();\n\n    /**\n     * 初始化底图\n     */\n    this.hooks.init.tapPromise('initMap', async () => {\n      // 等待首次相机同步\n      await new Promise<void>((resolve) => {\n        this.map.onCameraChanged((viewport: IViewport) => {\n          this.cameraService.init();\n          this.cameraService.update(viewport);\n          if (this.map.version !== 'GAODE2.x') {\n            // not amap2\n            resolve();\n          }\n        });\n        // @ts-ignore\n        this.map.initMiniMap();\n      });\n\n      // 重新绑定非首次相机更新事件\n      this.map.onCameraChanged(this.handleMapCameraChanged);\n\n      // 地图初始化之后 才能初始化 container 上的交互\n      this.interactionService.init();\n      this.interactionService.on(\n        InteractionEvent.Drag,\n        this.addSceneEvent.bind(this),\n      );\n    });\n\n    /**\n     * 初始化渲染引擎\n     */\n    this.hooks.init.tapPromise('initRenderer', async () => {\n      // 创建底图之上的 container\n      const $container = sceneConfig.canvas;\n\n      // 添加marker container;\n      this.$container = $container ? $container : null;\n      if (this.$container) {\n        await this.rendererService.init(\n          // @ts-ignore\n          sceneConfig.canvas,\n          this.configService.getSceneConfig(this.id) as IRenderConfig,\n        );\n      } else {\n        console.error('容器 id 不存在');\n      }\n\n      this.pickingService.init(this.id);\n    });\n    // TODO：init worker, fontAtlas...\n\n    // 执行异步并行初始化任务\n    // @ts-ignore\n    this.initPromise = this.hooks.init.promise();\n    this.render();\n  }\n\n  public addLayer(layer: ILayer) {\n    this.layerService.sceneService = this;\n    this.layerService.add(layer);\n    this.render();\n  }\n\n  public async render() {\n    if (this.rendering || this.destroyed) {\n      return;\n    }\n    this.rendering = true;\n    // 首次初始化，或者地图的容器被强制销毁的需要重新初始化\n    if (!this.inited) {\n      // 还未初始化完成需要等待\n\n      await this.initPromise;\n      if (this.destroyed) {\n        this.destroy();\n      }\n      // @ts-ignore\n      if (this.loadFont && document.fonts) {\n        // @ts-ignore\n        await document.fonts.load(`24px ${this.fontFamily}`, 'L7text');\n      }\n      // FIXME: 初始化 marker 容器，可以放到 map 初始化方法中？\n      this.layerService.initLayers();\n      this.controlService.addControls();\n      this.loaded = true;\n      this.emit('loaded');\n      this.inited = true;\n    }\n\n    // 尝试初始化未初始化的图层\n    this.layerService.updateLayerRenderList();\n    this.layerService.renderLayers();\n\n    // 组件需要等待layer 初始化完成之后添加\n    this.rendering = false;\n  }\n\n  /**\n   * 用户自定义添加第三方字体 （用户使用 layer/point/text/iconfont 的前提需要加载第三方字体文件）\n   * @param fontFamily\n   * @param fontPath\n   */\n  public addFontFace(fontFamily: string, fontPath: string): void {\n    this.fontFamily = fontFamily;\n    const style = document.createElement('style');\n    style.type = 'text/css';\n    style.innerText = `\n        @font-face{\n            font-family: '${fontFamily}';\n            src: url('${fontPath}') format('woff2'),\n            url('${fontPath}') format('woff'),\n            url('${fontPath}') format('truetype');\n        }`;\n    document.getElementsByTagName('head')[0].appendChild(style);\n    this.loadFont = true;\n  }\n\n  public getSceneContainer(): HTMLDivElement {\n    return this.$container as HTMLDivElement;\n  }\n\n  public exportPng(type?: 'png' | 'jpg'): string {\n    const renderCanvas = this.$container?.getElementsByTagName('canvas')[0];\n    this.render();\n    const layersPng =\n      type === 'jpg'\n        ? (renderCanvas?.toDataURL('image/jpeg') as string)\n        : (renderCanvas?.toDataURL('image/png') as string);\n    return layersPng;\n  }\n\n  public getSceneConfig(): Partial<ISceneConfig> {\n    return this.configService.getSceneConfig(this.id as string);\n  }\n\n  public addMarkerContainer(): void {\n    // @ts-ignore\n    const mapContainer = this.$container.parentElement as HTMLElement;\n    if (mapContainer !== null) {\n      this.markerContainer = DOM.create(\n        'div',\n        'l7-marker-container',\n        mapContainer,\n      );\n    }\n  }\n\n  public getMarkerContainer() {\n    return this.markerContainer;\n  }\n\n  public destroy() {\n    if (!this.inited) {\n      this.destroyed = true;\n      return;\n    }\n    this.emit('destroy');\n\n    this.layerService.destroy();\n    this.rendererService.destroy();\n    this.map.destroy();\n\n    this.interactionService.destroy();\n    this.controlService.destroy();\n    this.markerService.destroy();\n\n    // TODO: 销毁 container 容器\n    this.$container?.parentNode?.removeChild(this.$container);\n\n    this.removeAllListeners();\n    this.inited = false;\n    unbind(this.$container as HTMLDivElement, this.handleWindowResized);\n    if ($window.matchMedia) {\n      $window\n        .matchMedia('screen and (min-resolution: 2dppx)')\n        ?.removeListener(this.handleWindowResized);\n    }\n  }\n\n  private handleWindowResized = () => {\n    this.emit('resize');\n    // @ts-check\n    if (this.$container) {\n      this.initContainer();\n      DOM.triggerResize();\n      this.coordinateSystemService.needRefresh = true;\n\n      //  repaint layers\n      this.render();\n    }\n  };\n  private initContainer() {\n    const pixelRatio = DOM.DPR;\n    const w = this.$container?.clientWidth || 400;\n    const h = this.$container?.clientHeight || 300;\n    const canvas = this.canvas;\n    if (canvas) {\n      canvas.width = w * pixelRatio;\n      canvas.height = h * pixelRatio;\n      // canvas.style.width = `${w}px`;\n      // canvas.style.height = `${h}px`;\n    }\n    this.rendererService.viewport({\n      x: 0,\n      y: 0,\n      width: pixelRatio * w,\n      height: pixelRatio * h,\n    });\n  }\n\n  private setCanvas() {\n    const pixelRatio = DOM.DPR;\n    const w = this.$container?.clientWidth || 400;\n    const h = this.$container?.clientHeight || 300;\n    const canvas = this.canvas;\n    canvas.width = w * pixelRatio;\n    canvas.height = h * pixelRatio;\n    // canvas.style.width = `${w}px`;\n    // canvas.style.height = `${h}px`;\n    canvas.style.width = '100%';\n    canvas.style.height = '100%';\n  }\n\n  private handleMapCameraChanged = (viewport: IViewport) => {\n    this.cameraService.update(viewport);\n    this.render();\n  };\n\n  private addSceneEvent(target: IInteractionTarget) {\n    this.emit(target.type, target);\n  }\n}\n"]},"metadata":{},"sourceType":"module"}