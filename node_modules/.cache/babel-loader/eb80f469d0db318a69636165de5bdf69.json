{"ast":null,"code":"import _asyncToGenerator from \"@babel/runtime/helpers/asyncToGenerator\";\nimport _initializerDefineProperty from \"@babel/runtime/helpers/initializerDefineProperty\";\nimport _classCallCheck from \"@babel/runtime/helpers/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/createClass\";\nimport _defineProperty from \"@babel/runtime/helpers/defineProperty\";\nimport _applyDecoratedDescriptor from \"@babel/runtime/helpers/applyDecoratedDescriptor\";\nimport _initializerWarningHelper from \"@babel/runtime/helpers/initializerWarningHelper\";\n\nvar _dec, _dec2, _dec3, _class, _class2, _descriptor;\n\nimport _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport { inject, injectable, postConstruct } from 'inversify';\nimport 'reflect-metadata';\nimport { TYPES } from '../../../types';\nvar PostProcessor = (_dec = injectable(), _dec2 = inject(TYPES.IRendererService), _dec3 = postConstruct(), _dec(_class = (_class2 = function () {\n  function PostProcessor() {\n    _classCallCheck(this, PostProcessor);\n\n    _initializerDefineProperty(this, \"rendererService\", _descriptor, this);\n\n    _defineProperty(this, \"passes\", []);\n\n    _defineProperty(this, \"readFBO\", void 0);\n\n    _defineProperty(this, \"writeFBO\", void 0);\n  }\n\n  _createClass(PostProcessor, [{\n    key: \"getReadFBO\",\n    value: function getReadFBO() {\n      return this.readFBO;\n    }\n  }, {\n    key: \"getWriteFBO\",\n    value: function getWriteFBO() {\n      return this.writeFBO;\n    }\n  }, {\n    key: \"render\",\n    value: function () {\n      var _render = _asyncToGenerator(_regeneratorRuntime.mark(function _callee(layer) {\n        var i, pass;\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                i = 0;\n\n              case 1:\n                if (!(i < this.passes.length)) {\n                  _context.next = 10;\n                  break;\n                }\n\n                pass = this.passes[i];\n                pass.setRenderToScreen(this.isLastEnabledPass(i));\n                _context.next = 6;\n                return pass.render(layer);\n\n              case 6:\n                if (i !== this.passes.length - 1) {\n                  this.swap();\n                }\n\n              case 7:\n                i++;\n                _context.next = 1;\n                break;\n\n              case 10:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function render(_x) {\n        return _render.apply(this, arguments);\n      }\n\n      return render;\n    }()\n  }, {\n    key: \"resize\",\n    value: function resize(width, height) {\n      this.readFBO.resize({\n        width: width,\n        height: height\n      });\n      this.writeFBO.resize({\n        width: width,\n        height: height\n      });\n    }\n  }, {\n    key: \"add\",\n    value: function add(pass, layer, config) {\n      pass.init(layer, config);\n      this.passes.push(pass);\n    }\n  }, {\n    key: \"insert\",\n    value: function insert(pass, index, layer, config) {\n      pass.init(layer, config);\n      this.passes.splice(index, 0, pass);\n    }\n  }, {\n    key: \"getPostProcessingPassByName\",\n    value: function getPostProcessingPassByName(name) {\n      return this.passes.find(function (p) {\n        return p.getName() === name;\n      });\n    }\n  }, {\n    key: \"init\",\n    value: function init() {}\n  }, {\n    key: \"isLastEnabledPass\",\n    value: function isLastEnabledPass(index) {\n      for (var i = index + 1; i < this.passes.length; i++) {\n        if (this.passes[i].isEnabled()) {\n          return false;\n        }\n      }\n\n      return true;\n    }\n  }, {\n    key: \"swap\",\n    value: function swap() {\n      var tmp = this.readFBO;\n      this.readFBO = this.writeFBO;\n      this.writeFBO = tmp;\n    }\n  }]);\n\n  return PostProcessor;\n}(), (_descriptor = _applyDecoratedDescriptor(_class2.prototype, \"rendererService\", [_dec2], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _applyDecoratedDescriptor(_class2.prototype, \"init\", [_dec3], Object.getOwnPropertyDescriptor(_class2.prototype, \"init\"), _class2.prototype)), _class2)) || _class);\nexport { PostProcessor as default };","map":{"version":3,"sources":["../../../../src/services/renderer/passes/PostProcessor.ts"],"names":["injectable","PostProcessor","inject","TYPES","i","pass","width","height","p","postConstruct","index","tmp"],"mappings":";;;;;;;;;;;AAAA,SAAA,MAAA,EAAA,UAAA,EAAA,aAAA,QAAA,WAAA;AACA,OAAA,kBAAA;AACA,SAAA,KAAA,QAAA,gBAAA;IAYqBC,a,WADpBD,UAAU,E,UAERE,MAAM,CAACC,KAAK,CAAN,gBAAA,C,UAiENM,aAAa,E;;;;;;oCA9DwC,E;;;;;;;;;WAItD,SAAA,UAAA,GAAoB;AAClB,aAAO,KAAP,OAAA;AACD;;;WAED,SAAA,WAAA,GAAqB;AACnB,aAAO,KAAP,QAAA;AACD;;;;+DAED,SAAA,OAAA,CAAA,KAAA,EAAA;AAAA,YAAA,CAAA,EAAA,IAAA;AAAA,eAAA,mBAAA,CAAA,IAAA,CAAA,SAAA,QAAA,CAAA,QAAA,EAAA;AAAA,iBAAA,CAAA,EAAA;AAAA,oBAAA,QAAA,CAAA,IAAA,GAAA,QAAA,CAAA,IAAA;AAAA,mBAAA,CAAA;AACWL,gBAAAA,CADX,GAAA,CACWA;;AADX,mBAAA,CAAA;AAAA,oBAAA,EACkBA,CAAC,GAAG,KAAA,MAAA,CADtB,MAAA,CAAA,EAAA;AAAA,kBAAA,QAAA,CAAA,IAAA,GAAA,EAAA;AAAA;AAAA;;AAEUC,gBAAAA,IAFV,GAEiB,KAAA,MAAA,CAFjB,CAEiB,CAAPA;AAENA,gBAAAA,IAAI,CAAJA,iBAAAA,CAAuB,KAAA,iBAAA,CAAvBA,CAAuB,CAAvBA;AAJJ,gBAAA,QAAA,CAAA,IAAA,GAAA,CAAA;AAAA,uBAKUA,IAAI,CAAJA,MAAAA,CALV,KAKUA,CALV;;AAAA,mBAAA,CAAA;AAQI,oBAAID,CAAC,KAAK,KAAA,MAAA,CAAA,MAAA,GAAV,CAAA,EAAkC;AAChC,uBAAA,IAAA;AACD;;AAVL,mBAAA,CAAA;AAC0CA,gBAAAA,CAD1C;AAAA,gBAAA,QAAA,CAAA,IAAA,GAAA,CAAA;AAAA;;AAAA,mBAAA,EAAA;AAAA,mBAAA,KAAA;AAAA,uBAAA,QAAA,CAAA,IAAA,EAAA;AAAA;AAAA;AAAA,SAAA,EAAA,OAAA,EAAA,IAAA,CAAA;;;;;;;;;;;WAcA,SAAA,MAAA,CAAA,KAAA,EAAA,MAAA,EAA6C;AAC3C,WAAA,OAAA,CAAA,MAAA,CAAoB;AAClBE,QAAAA,KAAK,EADa,KAAA;AAElBC,QAAAA,MAAM,EAANA;AAFkB,OAApB;AAIA,WAAA,QAAA,CAAA,MAAA,CAAqB;AACnBD,QAAAA,KAAK,EADc,KAAA;AAEnBC,QAAAA,MAAM,EAANA;AAFmB,OAArB;AAID;;;WAED,SAAA,GAAA,CAAA,IAAA,EAAA,KAAA,EAAA,MAAA,EAIE;AACAF,MAAAA,IAAI,CAAJA,IAAAA,CAAAA,KAAAA,EAAAA,MAAAA;AACA,WAAA,MAAA,CAAA,IAAA,CAAA,IAAA;AACD;;;WAED,SAAA,MAAA,CAAA,IAAA,EAAA,KAAA,EAAA,KAAA,EAAA,MAAA,EAKE;AACAA,MAAAA,IAAI,CAAJA,IAAAA,CAAAA,KAAAA,EAAAA,MAAAA;AACA,WAAA,MAAA,CAAA,MAAA,CAAA,KAAA,EAAA,CAAA,EAAA,IAAA;AACD;;;WAED,SAAA,2BAAA,CAAA,IAAA,EAE4C;AAC1C,aAAO,KAAA,MAAA,CAAA,IAAA,CAAiB,UAAA,CAAA,EAAA;AAAA,eAAOG,CAAC,CAADA,OAAAA,OAAP,IAAA;AAAxB,OAAO,CAAP;AACD;;;WAED,SAAA,IAAA,GACe,CAkBd;;;WAED,SAAA,iBAAA,CAAA,KAAA,EAAkD;AAChD,WAAK,IAAIJ,CAAC,GAAGM,KAAK,GAAlB,CAAA,EAAwBN,CAAC,GAAG,KAAA,MAAA,CAA5B,MAAA,EAAgDA,CAAhD,EAAA,EAAqD;AACnD,YAAI,KAAA,MAAA,CAAA,CAAA,EAAJ,SAAI,EAAJ,EAAgC;AAC9B,iBAAA,KAAA;AACD;AACF;;AACD,aAAA,IAAA;AACD;;;WAED,SAAA,IAAA,GAAe;AACb,UAAMO,GAAG,GAAG,KAAZ,OAAA;AACA,WAAA,OAAA,GAAe,KAAf,QAAA;AACA,WAAA,QAAA,GAAA,GAAA;AACD;;;;;;;;;;SApGkBV,a","sourcesContent":["import { inject, injectable, postConstruct } from 'inversify';\nimport 'reflect-metadata';\nimport { TYPES } from '../../../types';\nimport { ILayer } from '../../layer/ILayerService';\nimport { gl } from '../gl';\nimport { IFramebuffer } from '../IFramebuffer';\nimport { IPostProcessingPass, IPostProcessor } from '../IMultiPassRenderer';\nimport { IRendererService } from '../IRendererService';\n\n/**\n * ported from Three.js EffectComposer\n * 后处理负责 pingpong read/write framebuffer，最后一个 pass 默认输出到屏幕\n */\n@injectable()\nexport default class PostProcessor implements IPostProcessor {\n  @inject(TYPES.IRendererService)\n  protected readonly rendererService: IRendererService;\n\n  private passes: Array<IPostProcessingPass<unknown>> = [];\n  private readFBO: IFramebuffer;\n  private writeFBO: IFramebuffer;\n\n  public getReadFBO() {\n    return this.readFBO;\n  }\n\n  public getWriteFBO() {\n    return this.writeFBO;\n  }\n\n  public async render(layer: ILayer) {\n    for (let i = 0; i < this.passes.length; i++) {\n      const pass = this.passes[i];\n      // last pass should render to screen\n      pass.setRenderToScreen(this.isLastEnabledPass(i));\n      await pass.render(layer);\n\n      // pingpong\n      if (i !== this.passes.length - 1) {\n        this.swap();\n      }\n    }\n  }\n\n  public resize(width: number, height: number) {\n    this.readFBO.resize({\n      width,\n      height,\n    });\n    this.writeFBO.resize({\n      width,\n      height,\n    });\n  }\n\n  public add<T>(\n    pass: IPostProcessingPass<T>,\n    layer: ILayer,\n    config?: Partial<T>,\n  ) {\n    pass.init(layer, config);\n    this.passes.push(pass);\n  }\n\n  public insert<T>(\n    pass: IPostProcessingPass<T>,\n    index: number,\n    layer: ILayer,\n    config?: Partial<T>,\n  ) {\n    pass.init(layer, config);\n    this.passes.splice(index, 0, pass);\n  }\n\n  public getPostProcessingPassByName(\n    name: string,\n  ): IPostProcessingPass<unknown> | undefined {\n    return this.passes.find((p) => p.getName() === name);\n  }\n\n  @postConstruct()\n  private init() {\n    // const { createFramebuffer, createTexture2D } = this.rendererService;\n    // this.readFBO = createFramebuffer({\n    //   color: createTexture2D({\n    //     width: 1,\n    //     height: 1,\n    //     wrapS: gl.CLAMP_TO_EDGE,\n    //     wrapT: gl.CLAMP_TO_EDGE,\n    //   }),\n    // });\n    // this.writeFBO = createFramebuffer({\n    //   color: createTexture2D({\n    //     width: 1,\n    //     height: 1,\n    //     wrapS: gl.CLAMP_TO_EDGE,\n    //     wrapT: gl.CLAMP_TO_EDGE,\n    //   }),\n    // });\n  }\n\n  private isLastEnabledPass(index: number): boolean {\n    for (let i = index + 1; i < this.passes.length; i++) {\n      if (this.passes[i].isEnabled()) {\n        return false;\n      }\n    }\n    return true;\n  }\n\n  private swap() {\n    const tmp = this.readFBO;\n    this.readFBO = this.writeFBO;\n    this.writeFBO = tmp;\n  }\n}\n"]},"metadata":{},"sourceType":"module"}